    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');

    :root {
        color-scheme: light;
        --color-bg-start: #FDFEFF;
        --color-bg-end: #F8F9FA;
        --color-primary: #0d2c54;
        --color-accent: #4DB1C8;
        --color-text: #33373D;
        --color-muted: #888B90;
        --color-border: #EAECEE;
        --color-border-strong: #D0E0E8;
        --color-card: #FFFFFF;
        --color-shadow: 0 10px 25px -10px rgba(13, 44, 84, 0.1);
        --color-shadow-strong: 0 18px 38px -18px rgba(13, 44, 84, 0.15);
    }

    html, body {
        font-family: 'Montserrat', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, 'Helvetica Neue', sans-serif;
        scroll-behavior: smooth;
        min-height: 100%;
        background: linear-gradient(180deg, var(--color-bg-start) 0%, var(--color-bg-end) 100%);
        color: var(--color-text);
    }

    .tabular { font-variant-numeric: tabular-nums; }
    .hidden { display: none !important; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .editable[contenteditable="true"]:empty:before {
        content: attr(data-ph);
        color: var(--color-muted);
        pointer-events: none;
        display: block;
    }
    .editable {
        outline: none;
        border: 1px solid var(--color-border);
        border-radius: 0.9rem;
        padding: 0.6rem 0.75rem;
        background: #fff;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .editable:focus {
        border-color: var(--color-accent);
        box-shadow: 0 0 0 4px rgba(77, 177, 200, 0.18);
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] { -moz-appearance: textfield; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out forwards; }

    @keyframes fadeOut {
        from { opacity: 1; transform: scale(0.95); }
        to { opacity: 0; transform: scale(1); }
    }
    .fade-out { animation: fadeOut 0.3s ease-in forwards; }

    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    details > summary .summary-arrow { transition: transform 0.2s; }
    details[open] > summary .summary-arrow { transform: rotate(90deg); }

    #toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 50;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .toast {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.9rem 1.15rem;
        border-radius: 1rem;
        box-shadow: var(--color-shadow);
        border: 1px solid var(--color-border);
        background-color: var(--color-card);
        color: var(--color-text);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.35s cubic-bezier(0.21, 1.02, 0.73, 1);
    }
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    .toast-success { background-color: rgba(77, 177, 200, 0.12); border-color: rgba(77, 177, 200, 0.35); color: var(--color-primary); }
    .toast-error { background-color: rgba(220, 53, 69, 0.14); border-color: rgba(220, 53, 69, 0.35); color: #b91c1c; }

    #chart-tooltip {
        position: absolute;
        z-index: 20;
        transition: opacity 0.2s;
        pointer-events: none;
        background: var(--color-card);
        border: 1px solid var(--color-border);
        color: var(--color-text);
        border-radius: 0.75rem;
        box-shadow: var(--color-shadow);
        padding: 0.5rem 0.75rem;
        opacity: 0;
        max-width: min(320px, 90vw);
        overflow-wrap: anywhere;
    }

    /* PATCH */
    .card {
        background: radial-gradient(circle at 18% 20%, rgba(77, 177, 200, 0.08), transparent 42%),
            radial-gradient(circle at 85% 15%, rgba(13, 44, 84, 0.06), transparent 38%),
            var(--color-card);
        border: 1px solid var(--color-border);
        border-radius: 1.5rem;
        box-shadow: var(--color-shadow);
        padding: 1.5rem;
        transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease;
    }

    /* PATCH */
    .freeze-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.3rem 0.6rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(13, 44, 84, 0.18);
        background: rgba(77, 177, 200, 0.12);
        color: var(--brand-ink, #0b2b5e);
        font-size: 0.72rem;
        font-weight: 600;
        transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    /* PATCH */
    .freeze-toggle[aria-pressed="true"] {
        background: rgba(13, 44, 84, 0.12);
        color: #0b2b5e;
        border-color: rgba(13, 44, 84, 0.3);
    }

    /* PATCH */
    .is-frozen-row {
        opacity: 0.7;
    }

    /* PATCH */
    .freeze-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        background: rgba(13, 44, 84, 0.08);
        color: var(--brand-ink, #0b2b5e);
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.02em;
    }
    @media (min-width: 640px) {
        .card { padding: 2rem; }
    }

    .card:hover {
        transform: translateY(-4px);
        border-color: var(--color-border-strong);
        box-shadow: var(--color-shadow-strong);
        background: radial-gradient(circle at 20% 18%, rgba(77, 177, 200, 0.12), transparent 45%),
            radial-gradient(circle at 80% 12%, rgba(13, 44, 84, 0.08), transparent 42%),
            var(--color-card);
    }

    .primary-btn, .secondary-btn, .danger-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border-radius: 0.9rem;
        padding: 0.65rem 1.1rem;
        font-weight: 600;
        font-size: 0.95rem;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .primary-btn {
        background: var(--color-primary);
        color: #fff;
        border: 1px solid var(--color-primary);
        box-shadow: var(--color-shadow);
    }
    .primary-btn:hover {
        box-shadow: var(--color-shadow-strong);
        background: #143d76;
        border-color: #143d76;
    }

    .secondary-btn {
        background: rgba(77, 177, 200, 0.12);
        color: var(--color-primary);
        border: 1px solid rgba(77, 177, 200, 0.4);
    }
    .secondary-btn:hover {
        background: rgba(77, 177, 200, 0.18);
        border-color: rgba(77, 177, 200, 0.55);
    }

    .danger-btn {
        background: rgba(220, 53, 69, 0.08);
        color: #b91c1c;
        border: 1px solid rgba(220, 53, 69, 0.35);
    }
    .danger-btn:hover {
        background: rgba(220, 53, 69, 0.14);
        border-color: rgba(220, 53, 69, 0.45);
    }

    .glass-input {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid var(--color-border);
        border-radius: 0.9rem;
        padding: 0.6rem 0.75rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .glass-input::placeholder {
        color: var(--color-muted);
    }
    .glass-input:focus {
        border-color: var(--color-accent);
        box-shadow: 0 0 0 4px rgba(77, 177, 200, 0.18);
        outline: none;
    }

    .form-checkbox {
        width: 1.05rem;
        height: 1.05rem;
        border-radius: 0.35rem;
        border: 1px solid var(--color-border);
        accent-color: var(--color-accent);
    }

    h1.report-title {
        font-size: 3.333rem;
        font-weight: 700;
        color: var(--color-primary);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    h2.section-title {
        font-size: 2.167rem;
        font-weight: 700;
        color: var(--color-primary);
        margin: 0;
    }
    h3.card-subtitle {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text);
        margin: 0;
    }
    p {
        font-size: 1.167rem;
        line-height: 1.6;
        color: var(--color-text);
    }
    .muted-text { color: var(--color-muted); font-size: 0.85rem; }
    .text-body { color: var(--color-text); }
    .text-muted { color: var(--color-muted); }
    .text-primary { color: var(--color-primary); }
    .text-accent { color: var(--color-accent); }
    .stat-value { font-size: 4rem; font-weight: 700; color: var(--color-accent); }
    .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.5rem 1.1rem;
        border-radius: 999px;
        background: rgba(13, 44, 84, 0.08);
        color: var(--color-primary);
        font-weight: 600;
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }
    .border-subtle { border-color: var(--color-border) !important; }
    .border-accent-soft { border-color: rgba(77, 177, 200, 0.35) !important; }
    .bg-accent-soft { background: rgba(77, 177, 200, 0.12); }
    #pie-time-slider { accent-color: var(--color-accent); }

    .report-header {
        padding: 4rem 1.5rem 2.5rem;
    }
    .report-header__inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
    }
    .brand-logo {
        font-size: 1.9rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        color: var(--color-primary);
    }
    .brand-logo span { color: var(--color-accent); }

    .hero-layout {
        display: grid;
        gap: 2.5rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        align-items: start;
    }
    .hero-intro { display: flex; flex-direction: column; gap: 1.5rem; }
    .hero-badges { display: flex; flex-wrap: wrap; gap: 1rem; }
    .hero-badge {
        background: rgba(13, 44, 84, 0.08);
        color: var(--color-primary);
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }
    .hero-disclaimer { font-size: 0.9rem; color: var(--color-muted); display: flex; flex-wrap: wrap; gap: 0.75rem; }

    .feature-stack {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }
    /* PATCH */
    .feature-card {
        background: linear-gradient(145deg, rgba(77, 177, 200, 0.07), transparent 46%), var(--color-card);
        border: 1px solid var(--color-border);
        border-radius: 1.5rem;
        padding: 1.3rem 1.4rem;
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease;
    }
    /* PATCH */
    .feature-card:hover {
        transform: translateY(-3px);
        border-color: var(--color-border-strong);
        box-shadow: var(--color-shadow-strong);
        background: linear-gradient(145deg, rgba(77, 177, 200, 0.12), transparent 50%), var(--color-card);
    }
    .feature-icon {
        width: 42px;
        height: 42px;
        border-radius: 1rem;
        background: rgba(77, 177, 200, 0.15);
        color: var(--color-primary);
        display: grid;
        place-items: center;
        flex-shrink: 0;
    }
    /* PATCH */
    .benefit {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.45rem;
        margin-block: 14px;
    }
    /* PATCH */
    .benefit-title {
        font-weight: 600;
        color: var(--color-primary);
    }
    /* PATCH */
    .benefit-desc {
        opacity: 0.85;
    }
    .feature-text { display: flex; flex-direction: column; gap: 0.35rem; }
    .feature-title { font-weight: 600; color: var(--color-primary); font-size: 1rem; }
    .feature-desc { font-size: 0.95rem; color: var(--color-text); line-height: 1.5; }

    .input-highlight {
        border-color: var(--color-accent) !important;
        box-shadow: 0 0 0 1px var(--color-accent);
    }

    .delete-row-button {
        color: var(--color-muted);
    }
    .delete-row-button:hover {
        color: #B2403D;
        background: rgba(178, 64, 61, 0.08);
    }

    .divider { height: 1px; background: var(--color-border); }

    .bg-card-soft { background: rgba(255, 255, 255, 0.85); }
    .bg-card-muted { background: rgba(255, 255, 255, 0.7); }
    .bg-divider { background: rgba(13, 44, 84, 0.12); }

    /* PATCH */
    .fund-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
        color: #ffffff;
        text-transform: uppercase;
        box-shadow: var(--color-shadow);
        background: var(--color-primary);
        flex-shrink: 0;
    }
    .fund-card__header { display: grid; gap: 1.4rem; grid-template-columns: auto 1fr; align-items: center; }
    .fund-card__name { font-size: 1.35rem; font-weight: 600; color: var(--color-primary); overflow-wrap: anywhere; }
    .fund-card__dot { width: 0.8rem; height: 0.8rem; border-radius: 999px; box-shadow: 0 0 0 3px rgba(13,44,84,0.1); }
    .fund-card__meta { display: flex; flex-wrap: wrap; gap: 0.6rem; font-size: 0.92rem; color: var(--color-muted); }
    .fund-card__meta span { padding: 0.35rem 0.75rem; border-radius: 999px; background: rgba(77,177,200,0.14); color: var(--color-primary); font-weight: 500; }
    .fund-card__metrics { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .fund-card__metric { background: rgba(13,44,84,0.04); border: 1px solid rgba(13,44,84,0.08); border-radius: 1.1rem; padding: 1rem 1.1rem; display: flex; flex-direction: column; gap: 0.5rem; }
    .fund-card__metric .metric-label { color: var(--color-muted); }
    .fund-card__metric .metric-value { color: var(--color-primary); font-weight: 600; }
    .fund-card__transactions { border-radius: 1.2rem; border: 1px solid var(--color-border); background: rgba(255,255,255,0.85); overflow: hidden; }
    .fund-card__transactions summary { padding: 0.75rem 1.1rem; display: flex; align-items: center; gap: 0.6rem; font-size: 0.9rem; font-weight: 600; color: var(--color-primary); cursor: pointer; background: rgba(77,177,200,0.08); }
    .fund-card__transactions summary:hover { background: rgba(77,177,200,0.14); }

    /* PATCH */
    .pie-segment,
    .pie-slice {
        cursor: pointer;
        transition: transform 0.25s ease, filter 0.25s ease;
        transform-origin: 50px 50px;
    }
    .pie-segment:hover,
    .pie-slice:hover {
        transform: scale(1.05);
        filter: drop-shadow(0 4px 8px rgba(13, 44, 84, 0.15));
    }
    .pie-segment:focus,
    .pie-segment:focus-visible,
    .pie-slice:focus,
    .pie-slice:focus-visible { outline: none; }
    .pie-segment:focus path,
    .pie-segment:focus-visible path,
    .pie-segment:focus circle,
    .pie-segment:focus-visible circle,
    .pie-slice:focus path,
    .pie-slice:focus-visible path {
        transform: scale(1.05);
        filter: drop-shadow(0 4px 8px rgba(13, 44, 84, 0.18));
    }
    .line-chart-grid-line { stroke: #E5E8EE; stroke-dasharray: 2 3; }
    .line-chart-axis-text { font-size: 12px; fill: var(--color-muted); }
    .line-chart-dot { cursor: pointer; transition: r 0.2s; outline: none; }
    .line-chart-dot:hover { r: 7; }
    .line-chart-dot:focus-visible { r: 7; outline: 2px solid var(--color-accent); outline-offset: 2px; }

    .text-positive { color: var(--color-accent); }
    .text-negative { color: #B2403D; }
    .muted { color: var(--color-muted); }

    /* Export report styling */
    .export-shell {
        max-width: 1080px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 3rem;
        padding: 3.5rem 2rem 4rem;
        background: linear-gradient(180deg, rgba(253,254,255,0.92) 0%, rgba(248,249,250,0.95) 100%);
    }
    .export-hero {
        background: var(--color-card);
        border-radius: 1.9rem;
        border: 2px solid var(--color-primary);
        padding: 3rem;
        box-shadow: none;
    }
    .export-hero__layout {
        display: grid;
        gap: 2.5rem;
    }
    .export-hero__content {
        display: flex;
        flex-direction: column;
        gap: 1.8rem;
    }
    .export-hero__features {
        display: grid;
        gap: 1rem;
    }
    .export-hero__features .feature-card { height: 100%; }
    @media (min-width: 960px) {
        .export-hero__layout { grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr); align-items: start; }
    }
    .export-hero__badge {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.55rem 1rem;
        border-radius: 999px;
        background: rgba(13,44,84,0.08);
        color: var(--color-primary);
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
    }
    .export-hero__title { font-size: 3.1rem; font-weight: 700; color: var(--color-primary); letter-spacing: 0.08em; text-transform: uppercase; margin: 0; overflow-wrap: anywhere; }
    .export-hero__lead { color: var(--color-text); line-height: 1.6; font-size: 1.1rem; margin: 0; }
    .export-hero__meta { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); }
    .export-hero__meta-item {
        background: rgba(255,255,255,0.9);
        border: 1px solid var(--color-border);
        border-radius: 1.2rem;
        padding: 1rem 1.2rem;
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
    }
    .meta-label { text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.7rem; color: var(--color-muted); font-weight: 600; }
    .meta-value { font-size: 1.1rem; font-weight: 600; color: var(--color-primary); }
    .export-hero__disclaimer { font-size: 0.9rem; color: var(--color-muted); line-height: 1.6; margin: 0; }

    .narrative { display: flex; flex-direction: column; gap: 1rem; background: var(--color-card); border-radius: 1.5rem; border: 1px solid var(--color-border); padding: 1.8rem 2.1rem; }
    .narrative h2 { margin: 0; font-size: 1.35rem; font-weight: 600; color: var(--color-primary); }
    .narrative p { margin: 0; font-size: 1rem; color: var(--color-text); }

    .section-heading { display: flex; flex-direction: column; gap: 0.5rem; }
    .section-heading .pill { align-self: flex-start; }
    .section-heading h2 { margin: 0; font-size: 2rem; font-weight: 700; color: var(--color-primary); overflow-wrap: anywhere; }
    .section-heading p { margin: 0; font-size: 1rem; color: var(--color-text); }
    .section-meta { margin: 0; font-size: 0.85rem; color: var(--color-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; }

    @media (min-width: 900px) {
        .section-heading { display: grid; grid-template-columns: 1fr auto; align-items: end; gap: 0.5rem 1.25rem; }
        .section-heading h2 { margin: 0; }
        .section-heading .section-meta { align-self: center; justify-self: end; }
        .section-heading .pill { grid-column: 1 / -1; }
    }

    .summary-grid { display: grid; gap: 1.2rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    /* PATCH */
    .summary-card { padding: 1.4rem 1.5rem; border-radius: 1.4rem; border: 1px solid var(--color-border); background: linear-gradient(180deg, rgba(77, 177, 200, 0.06), transparent 45%), var(--color-card); display: flex; flex-direction: column; justify-content: space-between; gap: 0.65rem; transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease; box-shadow: var(--color-shadow); }
    /* PATCH */
    .summary-card:hover { transform: translateY(-3px); border-color: var(--color-border-strong); box-shadow: var(--color-shadow-strong); background: linear-gradient(180deg, rgba(77, 177, 200, 0.1), transparent 55%), var(--color-card); }
    .summary-label { text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.7rem; color: var(--color-muted); font-weight: 600; }
    /* PATCH: Summary values – keep large figures inside cards */
    .summary-value {
        font-size: clamp(1.4rem, 3.2vw, 2rem);
        font-weight: 700;
        color: var(--color-primary);
        line-height: 1.05;
        white-space: nowrap;
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum" 1, "lnum" 1;
    }
    .summary-note { font-size: 0.9rem; color: var(--color-muted); margin: 0; }
    .summary-warning { margin-bottom: 1rem; padding: 1rem 1.25rem; border-radius: 1rem; border: 1px solid rgba(220,53,69,0.25); background: rgba(220,53,69,0.08); color: #7f1d1d; font-size: 0.95rem; line-height: 1.5; }

    .fund-export-grid { display: flex; flex-direction: column; gap: 1.65rem; }
    .fund-export { background: var(--color-card); border-radius: 1.6rem; border: 1px solid var(--color-border); padding: 1.85rem; display: flex; flex-direction: column; gap: 1.4rem; }
    .fund-export__header { display: grid; gap: 1.2rem; grid-template-columns: auto 1fr; align-items: center; }
    .fund-export__title { display: flex; flex-direction: column; gap: 0.5rem; overflow-wrap: anywhere; }
    .fund-export__meta { display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.85rem; color: var(--color-muted); }
    .fund-export__meta span { padding: 0.4rem 0.7rem; border-radius: 999px; background: rgba(77,177,200,0.12); color: var(--color-primary); font-weight: 500; }
    .fund-export__metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 1rem; }
    .fund-export__metric { background: rgba(77,177,200,0.08); border: 1px solid rgba(77,177,200,0.2); border-radius: 1.15rem; padding: 1rem 1.1rem; display: flex; flex-direction: column; gap: 0.5rem; }
    .metric-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--color-muted); font-weight: 600; }
    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-primary);
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum" 1, "lnum" 1;
        white-space: nowrap;
    }
    .metric-sub { font-size: 0.78rem; color: var(--color-muted); }

    .fund-export__table-wrapper { overflow-x: auto; border-radius: 1.15rem; border: 1px solid var(--color-border); background: rgba(248,249,250,0.9); mask-image: linear-gradient(to right, transparent, #000 16px, #000 calc(100% - 16px), transparent); }
    .fund-export__table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .fund-export__table th,
    .fund-export__table td { padding: 0.85rem 1rem; border-bottom: 1px solid rgba(234,236,238,0.7); }
    .fund-export__table th { text-align: left; font-weight: 600; color: var(--color-muted); background: rgba(242,244,246,0.8); text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.72rem; position: sticky; top: 0; z-index: 1; }
    .fund-export__table th.text-right,
    .fund-export__table td.text-right { text-align: right; }

    .line-export { display: flex; flex-direction: column; gap: 1.35rem; border-radius: 1.55rem; padding: 2rem; background: var(--color-card); border: 1px solid var(--color-border); }
    .line-canvas { border-radius: 1.25rem; overflow: hidden; background: #ffffff; border: 1px solid var(--color-border); }
    .line-canvas svg { width: 100%; height: auto; display: block; }
    .line-legend { display: flex; flex-wrap: wrap; gap: 0.6rem; align-items: center; }
    .legend-pill { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.45rem 0.9rem; border-radius: 999px; font-size: 0.78rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; border: 1px solid transparent; max-width: 100%; }
    .legend-pill span, .legend-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .legend-pill:focus-visible { outline: 2px solid rgba(13,44,84,0.45); outline-offset: 3px; }
    .legend-pill--base { background: rgba(51,55,61,0.1); color: var(--color-text); border-color: rgba(51,55,61,0.2); }
    .legend-pill--value { background: rgba(77,177,200,0.18); color: var(--color-primary); border-color: rgba(77,177,200,0.35); }
    .legend-pill--projection { background: rgba(13,44,84,0.1); color: var(--color-primary); border-color: rgba(13,44,84,0.25); }
    .chart-footnote { margin: 0; font-size: 0.9rem; color: var(--color-muted); line-height: 1.6; }

    .export-footer { margin-top: 2rem; text-align: center; font-size: 0.85rem; color: var(--color-muted); }
    /* PATCH */
    .footer-note { margin: 0; font-size: 0.85rem; color: var(--color-muted); }

    @media (prefers-reduced-motion: reduce) {
        * { transition: none !important; animation: none !important; }
    }

    @page { margin: 14mm; }

    @media print {
        body { background: #ffffff !important; }
        .export-shell { background: #ffffff; padding: 0; }
        .card { box-shadow: none !important; border-color: #d7dbe0; page-break-inside: avoid; break-inside: avoid; }
        .summary-card, .fund-export, .line-export, .pie-export, .export-hero { page-break-inside: avoid; break-inside: avoid; }
        #chart-tooltip { display: none !important; }
    }

    .pie-export { display: grid; gap: 1.6rem; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); align-items: center; }
    .pie-canvas { display: flex; justify-content: center; }
    .pie-canvas svg { max-width: 320px; width: 100%; height: auto; }
    .pie-legend { display: flex; flex-direction: column; gap: 0.85rem; }
    .legend-item { display: flex; align-items: center; justify-content: space-between; gap: 0.85rem; font-size: 0.95rem; color: var(--color-text); padding: 0.7rem 1rem; border-radius: 0.9rem; background: var(--color-card); border: 1px solid var(--color-border); }
    .legend-dot { width: 0.9rem; height: 0.9rem; border-radius: 999px; flex-shrink: 0; box-shadow: 0 0 0 3px rgba(13,44,84,0.1); }
    .legend-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
    .legend-value { font-weight: 600; color: var(--color-primary); }

    .export-explanations { display: grid; gap: 1.3rem; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); font-size: 0.96rem; color: var(--color-text); }
    .export-explanations article { background: var(--color-card); border-radius: 1.3rem; border: 1px solid var(--color-border); padding: 1.45rem; display: flex; flex-direction: column; gap: 0.8rem; }
    .export-explanations h3 { margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--color-primary); }

    .disclaimer-block { display: flex; flex-direction: column; gap: 0.9rem; background: rgba(255,255,255,0.95); border: 1px solid rgba(220,53,69,0.25); border-radius: 1.2rem; padding: 1.35rem 1.5rem; }
    .disclaimer-title { font-size: 0.88rem; font-weight: 600; color: #b91c1c; text-transform: uppercase; letter-spacing: 0.08em; margin: 0; }
    .disclaimer-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
    .disclaimer-item { display: flex; gap: 0.75rem; font-size: 0.9rem; color: var(--color-text); line-height: 1.6; }

    @media (max-width: 768px) {
        .report-header { padding: 3rem 1rem 2rem; }
        .export-hero { padding: 2.2rem; }
        h1.report-title { font-size: 2.6rem; }
        h2.section-title { font-size: 1.9rem; }
    }
</head>
<body>
  <div class="export-shell">
    ${heroSection}
    ${currencyWarning}
    ${narrativeSection}
    ${summarySection}
    ${fundsSection}
    ${pieSection}
    ${lineSection}
    ${disclaimerSection}
    ${explanationsSection}
    ${footerSection}
  </div>
  <script>${scriptBundle}${SCRIPT_CLOSE_TAG}
</body>
</html>`;

      try {
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const anchor = document.createElement('a');
          const safeName = clientName.toLowerCase().replace(/[^\p{L}\p{N}\s-]+/gu, '').trim().replace(/\s+/g, '-');
          anchor.href = url;
          anchor.download = `report-${safeName || 'klient'}-${generatedAt.toISOString().split('T')[0]}.html`;
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);
          URL.revokeObjectURL(url);
          showToast('Report byl exportován.');
      } catch (err) {
          failExport(err);
      }
  };

  const calculateAnnuity = () => {
      const { portfolioSummary, activeFunds } = state.lastProcessedData;
      const { portfolioIrr, totalCurrentActive } = portfolioSummary;
      const monthlyAnnuity = utils.numCZ(elements.annuityInput?.value);
      const resultDiv = elements.annuityResult || document.getElementById('annuity-result');
      const annualDiv = elements.annuityAnnual || document.getElementById('annuity-annual-equivalent');
      const disclaimer = elements.annuityDisclaimer || document.getElementById('annuity-disclaimer');
      if (!resultDiv || !annualDiv || !disclaimer) {
          return;
      }
      if (!isFinite(monthlyAnnuity) || monthlyAnnuity <= 0) {
          resultDiv.style.display = 'none';
          annualDiv.textContent = '';
          disclaimer.style.display = 'none';
          return;
      }
      disclaimer.style.display = 'block';
      const annualAnnuity = monthlyAnnuity * 12;
      annualDiv.textContent = `(což odpovídá ${formatCurrency0(annualAnnuity, 'CZK', { withUnit: true })} ročně)`;
      const activeList = Array.isArray(activeFunds) ? activeFunds : [];
      if (!isFinite(portfolioIrr) || portfolioIrr <= 0 || activeList.length === 0) {
          resultDiv.innerHTML = 'Pro výpočet renty je potřeba mít v portfoliu data s kladným zhodnocením (XIRR).';
          resultDiv.style.display = 'block';
          return;
      }
      const targetCapital = annualAnnuity / portfolioIrr;
      if (totalCurrentActive >= targetCapital) {
          resultDiv.innerHTML = `<strong>Gratulujeme!</strong> Vaše portfolio s aktuální hodnotou <strong>${formatCurrency0(totalCurrentActive, 'CZK', { withUnit: true })}</strong> je již nyní dostatečně velké, aby generovalo požadovanou roční rentu.`;
          resultDiv.style.display = 'block';
          return;
      }
      const dailyRate = Math.pow(1 + portfolioIrr, 1 / 365.25) - 1;
      let days = 0;
      let futureValue = totalCurrentActive;
      for (let i = 0; i < 365 * 100; i++) {
          futureValue *= (1 + dailyRate);
          days++;
          if (futureValue >= targetCapital) break;
      }
      if (futureValue < targetCapital) {
          resultDiv.innerHTML = `Při současném tempu růstu se Vám nepodaří dosáhnout cílové částky v rozumném časovém horizontu.`;
          resultDiv.style.display = 'block';
          return;
      }
      const targetDate = new Date();
      targetDate.setDate(targetDate.getDate() + days);
      const monthNames = ["ledna", "února", "března", "dubna", "května", "června", "července", "srpna", "září", "října", "listopadu", "prosince"];
      const formattedDate = `${monthNames[targetDate.getMonth()]} ${targetDate.getFullYear()}`;
      resultDiv.innerHTML = `Pro měsíční rentu <strong>${formatCurrency0(monthlyAnnuity, 'CZK', { withUnit: true })}</strong> potřebujete kapitál o velikosti přibližně <strong>${formatCurrency0(targetCapital, 'CZK', { withUnit: true })}</strong>. Při současném tempu růstu byste této částky mohli dosáhnout okolo <strong>${formattedDate}</strong>.`;
      resultDiv.style.display = 'block';
  };

  const handleInputChange = (e) => {
    const target = e.target;
    const key = target.dataset.key;
    if (!key) return;
    const tr = target.closest('tr');
    if (!tr) return;
    const id = parseInt(tr.dataset.id, 10);
    const providerKey = tr.closest('tbody').dataset.tbodyFor;
    const row = state.rows[providerKey].find(r => r.id === id);
    if (!row) return;
    if (target.type === 'checkbox') {
        row[key] = target.checked;
    } else {
        row[key] = target.isContentEditable ? target.textContent : target.value;
    }
    if (['invest', 'qty', 'issueNav', 'currNav', 'totalCurrent'].includes(key)) {
        const p = parseRow(row);
        if (isFinite(p.invest) && isFinite(p.issueNav) && p.issueNav > 0 && (!row.qty || utils.numCZ(row.qty) <= 0)) {
            row.qty = String(p.invest / p.issueNav);
            tr.querySelector('[data-key="qty"]').value = row.qty;
        } else if (isFinite(p.qty) && isFinite(p.issueNav) && p.qty > 0 && (!row.invest || utils.numCZ(row.invest) <= 0)) {
            row.invest = String(p.qty * p.issueNav);
            tr.querySelector('[data-key="invest"]').value = row.invest;
        }
        if (isFinite(p.qty) && isFinite(p.currNav) && p.currNav > 0 && (!row.totalCurrent || utils.numCZ(row.totalCurrent) <= 0)) {
             row.totalCurrent = String(p.qty * p.currNav);
             tr.querySelector('[data-key="totalCurrent"]').value = row.totalCurrent;
        }
    }
    updateInputHighlights(tr, row);
    scheduleRecalc();
    saveState();
  };

  const updateInputHighlights = (tr, row) => {
      const parsed = parseRow(row || {});
      const fields = ['invest', 'dateIn', 'qty', 'issueNav', 'currNav', 'totalCurrent', 'currDate'];
      fields.forEach(field => {
          const input = tr.querySelector(`[data-key="${field}"]`);
          if (input) input.classList.remove('input-highlight');
      });
      if (!parsed || !parsed.fund) {
          return;
      }
      const markMissing = (...keys) => {
          keys.forEach(field => {
              const input = tr.querySelector(`[data-key="${field}"]`);
              if (!input) return;
              const currentValue = row?.[field];
              if (currentValue === undefined || String(currentValue).trim() === '') {
                  input.classList.add('input-highlight');
              }
          });
      };
      if (!parsed.dateIn) markMissing('dateIn');
      if (!parsed.currDate) markMissing('currDate');
      const hasInvest = Number.isFinite(parsed.invest) && parsed.invest > 0;
      const hasQty = Number.isFinite(parsed.qty) && parsed.qty > 0;
      const hasIssueNav = Number.isFinite(parsed.issueNav) && parsed.issueNav > 0;
      const hasCurrent = Number.isFinite(parsed.totalCurrent);
      const hasNav = Number.isFinite(parsed.currNav) && parsed.currNav > 0;
      if (!hasInvest && !hasQty) {
          markMissing('invest');
      } else if (!hasInvest && hasQty && !hasIssueNav) {
          markMissing('issueNav');
      }
      if (!hasCurrent && !hasNav) {
          markMissing('currNav', 'totalCurrent');
      }
  };

  const init = () => {
    elements.fxRate = document.getElementById('fx-rate');
    elements.outCurrency = document.getElementById('out-curr');
    elements.statusContainer = document.getElementById('status-container');
    elements.toastContainer = document.getElementById('toast-container');
    elements.lastSavedIndicator = document.getElementById('last-saved-indicator');
    elements.providerSections = document.getElementById('provider-sections');
    elements.fundsContainer = document.getElementById('funds-by-card-container');
    elements.amountNoteFunds = document.getElementById('amount-note-funds');
    elements.portfolioSummary = document.getElementById('portfolio-summary-content');
    elements.amountNotePortfolio = document.getElementById('amount-note-portfolio');
    elements.lineChartCard = document.getElementById('line-chart-card');
    elements.pieChartCard = document.getElementById('pie-chart-card');
    elements.chartsSection = document.getElementById('charts-section');
    elements.lineChartContainer = document.getElementById('line-chart-container');
    elements.pieChartContainer = document.getElementById('pie-chart-container');
    elements.pieSlider = document.getElementById('pie-time-slider');
    elements.sliderStartLabel = document.getElementById('slider-start-date-label');
    elements.sliderCurrentLabel = document.getElementById('slider-current-date-label');
    elements.sliderEndLabel = document.getElementById('slider-end-date-label');
    elements.annuityInput = document.getElementById('annuity-input');
    elements.annuityAnnual = document.getElementById('annuity-annual-equivalent');
    elements.annuityResult = document.getElementById('annuity-result');
    elements.annuityDisclaimer = document.getElementById('annuity-disclaimer');
    elements.chartTooltip = document.getElementById('chart-tooltip');
    elements.importFile = document.getElementById('import-file-input');
    elements.clientNameInput = document.getElementById('client-name');
    elements.clientSalutationInput = document.getElementById('client-salutation');
    elements.clientToneInputs = Array.from(document.querySelectorAll('input[name="client-tone"]'));
    /* PATCH */
    elements.clientGenderInputs = Array.from(document.querySelectorAll('input[name="client-gender"]'));
    /* PATCH */
    elements.clientLanguageInputs = Array.from(document.querySelectorAll('input[name="client-language"]'));
    if (elements.clientNameInput) {
        elements.clientNameInput.value = state.clientName;
    }
    if (elements.clientSalutationInput) {
        elements.clientSalutationInput.value = state.clientSalutation;
    }
    /* PATCH */
    updateGenderInputs();
    updateToneInputs();
    /* PATCH */
    updateLanguageInputs();
    const currentYearEl = document.getElementById('current-year');
    if (currentYearEl) {
        currentYearEl.textContent = new Date().getFullYear();
    }
    const providerContainer = elements.providerSections;
    if (providerContainer) {
        Object.keys(PROVIDERS).forEach(key => providerContainer.appendChild(createProviderSection(key)));
    }
    document.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]'); if (!button) return;
        const { action, provider, id } = button.dataset;
        if (action === 'add-row') { const newId = ++rowSeq; state.rows[provider].push({ id: newId, fund: '', curr: 'CZK', freeze: false }); renderProviderInputs(provider, newId); }
        if (action === 'delete-row') { const rowElement = button.closest('tr'); rowElement.className = 'fade-out'; rowElement.addEventListener('animationend', () => { state.rows[provider] = state.rows[provider].filter(r => r.id !== parseInt(id,10)); rowElement.remove(); scheduleRecalc(); saveState(); }); }
        if (action === 'delete-all') { if (confirm(`Opravdu chcete smazat všechny řádky pro ${PROVIDERS[provider]}?`)) { state.rows[provider] = []; renderProviderInputs(provider); scheduleRecalc(); saveState(); } }
        /* PATCH */
        if (action === 'toggle-freeze') {
            const targetId = parseInt(id, 10);
            const list = state.rows[provider];
            const row = list.find(r => r.id === targetId);
            if (row) {
                row.freeze = !row.freeze;
                renderProviderInputs(provider);
                scheduleRecalc();
                saveState();
            }
        }
        if (action === 'export-json') exportState();
        if (action === 'import-json') elements.importFile?.click();
        if (action === 'export-html') exportToStaticHTML();
        if (action === 'add-sample') {
            const today = new Date().toISOString().split('T')[0];
            const SAMPLES = {
                avant: [ { id: ++rowSeq, fund: 'r2p invest SICAV, a.s.', invest: '100000', dateIn: '15.03.2021', issueNav: '1.05', currNav: '1.25', currDate: today, curr: 'CZK', freeze: false } ],
                codya: [ { id: ++rowSeq, fund: 'CODYA Real Estate Fund', invest: '250000', dateIn: '20.11.2020', issueNav: '10.0', currNav: '14.2', currDate: today, curr: 'CZK', freeze: false }, { id: ++rowSeq, fund: 'CODYA Opportunity', invest: '120000', dateIn: '10.01.2023', issueNav: '100', currNav: '118', currDate: today, curr: 'CZK', freeze: false } ],
                atris: [ { id: ++rowSeq, fund: 'ATRIS Global Equities', invest: '15000', dateIn: '30.05.2022', issueNav: '150', currNav: '195', currDate: today, curr: 'EUR', freeze: false } ],
                jt: [ { id: ++rowSeq, fund: 'J&T Opportunity CZK', invest: '500000', dateIn: '01.07.2019', issueNav: '1.0', currNav: '1.48', currDate: today, curr: 'CZK', freeze: false } ]
            };
            const sampleData = SAMPLES[provider].map(s => ({...s, qty: '', totalCurrent: ''}));
            state.rows[provider].push(...sampleData);
            renderProviderInputs(provider); scheduleRecalc(); showToast(`Ukázková data pro ${PROVIDERS[provider]} byla načtena.`); saveState();
        }
    });
    elements.fxRate?.addEventListener('input', scheduleRecalc);
    elements.outCurrency?.addEventListener('change', scheduleRecalc);
    elements.annuityInput?.addEventListener('input', calculateAnnuity);
    elements.clientNameInput?.addEventListener('input', (e) => {
        state.clientName = e.target.value;
        saveState();
    });
    elements.clientNameInput?.addEventListener('blur', (e) => {
        const trimmed = e.target.value.trim();
        if (trimmed !== e.target.value) {
            e.target.value = trimmed;
        }
        state.clientName = trimmed;
        saveState();
    });
    elements.clientSalutationInput?.addEventListener('input', (e) => {
        state.clientSalutation = e.target.value;
        saveState();
    });
    elements.clientSalutationInput?.addEventListener('blur', (e) => {
        const trimmed = e.target.value.trim();
        if (trimmed !== e.target.value) {
            e.target.value = trimmed;
        }
        state.clientSalutation = trimmed;
        saveState();
    });
    elements.clientToneInputs.forEach((input) => {
        input.addEventListener('change', (e) => {
            if (!e.target.checked) return;
            state.clientTone = e.target.value === 'tykani' ? 'tykani' : 'vykani';
            updateToneInputs();
            saveState();
        });
    });
    /* PATCH */
    elements.clientGenderInputs.forEach((input) => {
        input.addEventListener('change', (e) => {
            if (!e.target.checked) return;
            state.clientGender = e.target.value === 'female' ? 'female' : 'male';
            updateGenderInputs();
            saveState();
        });
    });
    /* PATCH */
    elements.clientLanguageInputs.forEach((input) => {
        input.addEventListener('change', (e) => {
            if (!e.target.checked) return;
            state.clientLanguage = e.target.value === 'en' ? 'en' : 'cs';
            updateLanguageInputs();
            saveState();
        });
    });
    const providerSections = elements.providerSections;
    if (providerSections) {
        providerSections.addEventListener('input', (e) => {
            if (e.target.matches('input, select')) handleInputChange(e);
        });
        providerSections.addEventListener('focusout', (e) => {
            if (e.target.isContentEditable) handleInputChange(e);
            const key = e.target.dataset.key;
            if (key === 'invest' || key === 'totalCurrent' || e.target.id === 'annuity-input') {
                const num = utils.numCZ(e.target.value);
                if (isFinite(num)) {
                    e.target.value = fmt0.format(num);
                } else {
                    e.target.value = '';
                }
            }
        });
        providerSections.addEventListener('focusin', (e) => {
            const key = e.target.dataset.key;
            if (key === 'invest' || key === 'totalCurrent' || e.target.id === 'annuity-input') {
                const num = utils.numCZ(e.target.value);
                if (isFinite(num)) {
                    e.target.value = num;
                }
            }
        });
        providerSections.addEventListener('keydown', e => { if (e.key === 'Enter' && e.target.isContentEditable) { e.preventDefault(); e.target.blur(); } });
    }
    elements.annuityInput?.addEventListener('focusin', (e) => {
        const num = utils.numCZ(e.target.value);
        if (isFinite(num)) {
            e.target.value = num;
        }
    });
    elements.annuityInput?.addEventListener('focusout', (e) => {
        const num = utils.numCZ(e.target.value);
        if (isFinite(num)) {
            e.target.value = fmt0.format(num);
        } else {
            e.target.value = '';
        }
    });
    elements.importFile?.addEventListener('change', (e) => { if (e.target.files.length > 0) { importState(e.target.files[0]); e.target.value = ''; } });
    elements.pieSlider?.addEventListener('input', updatePieChartFromSlider);
    const tooltip = elements.chartTooltip || document.getElementById('chart-tooltip');
    document.addEventListener('mousemove', e => {
        let newLeft = e.pageX + 15;
        let newTop = e.pageY + 15;
        if (tooltip.offsetWidth && newLeft + tooltip.offsetWidth > window.innerWidth) {
            newLeft = e.pageX - tooltip.offsetWidth - 15;
        }
        tooltip.style.left = `${newLeft}px`;
        tooltip.style.top = `${newTop}px`;
    });
    document.addEventListener('mouseover', e => {
        const segment = e.target.closest('.pie-segment');
        const dot = e.target.closest('.line-chart-dot, circle[data-tooltip-text]');
        if (segment) {
            tooltip.innerHTML = `<div class="font-bold text-primary">${segment.dataset.name}</div><div class="text-body">${segment.dataset.value} (${segment.dataset.percent})</div>`;
            tooltip.classList.remove('hidden');
            tooltip.style.opacity = '1';
        } else if (dot && dot.dataset.tooltipText) {
            tooltip.innerHTML = dot.dataset.tooltipText.replace(/&quot;/g, '"');
            tooltip.classList.remove('hidden');
            tooltip.style.opacity = '1';
        }
    });
    document.addEventListener('mouseout', e => {
        if (e.target.closest('.pie-segment, .line-chart-dot, circle[data-tooltip-text]')) {
            tooltip.classList.add('hidden');
            tooltip.style.opacity = '0';
        }
    });
    loadState();
  };
  init();
});
</script>
</body>
</html>