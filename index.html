<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investiční Kalkulačka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            color-scheme: light;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background: linear-gradient(180deg, #f6f8fb 0%, #eef2fb 100%);
            color: #0f1c2f;
            min-height: 100vh;
            margin: 0;
        }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        a { color: inherit; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary .summary-arrow { transition: transform 0.2s; }
        details[open] > summary .summary-arrow { transform: rotate(90deg); }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 50; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.25rem; border-radius: 14px; box-shadow: 0 18px 35px -18px rgba(15, 23, 42, 0.35); opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
        .toast-error { background-color: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
        .report-shell {
            max-width: 1180px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        @media (min-width: 1280px) {
            .report-shell { padding: 0 2.5rem; }
        }
        .report-hero {
            background: radial-gradient(120% 140% at 15% 10%, rgba(40, 82, 190, 0.12) 0%, rgba(40, 82, 190, 0) 55%),
                        radial-gradient(120% 140% at 80% 0%, rgba(14, 165, 233, 0.22) 0%, rgba(14, 165, 233, 0) 60%),
                        linear-gradient(180deg, #f9fbff 0%, #e3ebff 100%);
            padding: 3.75rem 0 5rem;
            border-bottom-left-radius: 56px;
            border-bottom-right-radius: 56px;
            position: relative;
            overflow: hidden;
        }
        .report-hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 110% 0%, rgba(59, 130, 246, 0.35), transparent 65%);
            pointer-events: none;
        }
        .report-hero-grid {
            position: relative;
            z-index: 1;
            display: grid;
            gap: 2.5rem;
        }
        @media (min-width: 1024px) {
            .report-hero-grid {
                grid-template-columns: minmax(0, 1.35fr) minmax(0, 1fr);
                align-items: center;
            }
        }
        .report-hero-kicker {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.85rem;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.25);
            font-size: 0.72rem;
            letter-spacing: 0.24em;
            text-transform: uppercase;
            color: #1d4ed8;
        }
        .report-hero-title {
            font-size: clamp(2rem, 5vw, 3.25rem);
            font-weight: 700;
            letter-spacing: -0.03em;
            line-height: 1.1;
            margin: 1rem 0 1.5rem;
            color: #0f1c2f;
        }
        .report-hero-text {
            font-size: 1rem;
            line-height: 1.6;
            max-width: 520px;
            color: rgba(15, 28, 47, 0.75);
        }
        .report-hero-brand {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.24em;
            text-transform: uppercase;
            color: #1f3f82;
        }
        .report-hero-cards {
            display: grid;
            gap: 1.35rem;
        }
        .report-hero-card {
            background: rgba(255, 255, 255, 0.94);
            border-radius: 26px;
            border: 1px solid rgba(199, 210, 254, 0.9);
            box-shadow: 0 34px 70px -50px rgba(30, 64, 175, 0.45);
            padding: 1.9rem;
        }
        .report-hero-card h3 {
            font-size: 1.05rem;
            font-weight: 600;
            color: #133178;
            margin-bottom: 0.6rem;
        }
        .report-hero-card p {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(15, 28, 47, 0.7);
        }
        .report-hero-card small {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.75rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(37, 99, 235, 0.7);
            margin-bottom: 0.85rem;
        }
        .report-main {
            margin-top: -72px;
            position: relative;
            z-index: 2;
        }
        @media (max-width: 768px) {
            .report-main { margin-top: -52px; }
        }
        .report-stack {
            display: flex;
            flex-direction: column;
            gap: 2.75rem;
            padding-bottom: 4.5rem;
        }
        .report-surface {
            background: #ffffff;
            border-radius: 32px;
            border: 1px solid rgba(199, 210, 254, 0.6);
            box-shadow: 0 45px 110px -80px rgba(15, 23, 42, 0.75);
            padding: clamp(1.75rem, 3vw, 2.75rem);
        }
        .report-surface--soft {
            background: linear-gradient(180deg, rgba(239, 246, 255, 0.75) 0%, rgba(255, 255, 255, 0.9) 100%);
            border-color: rgba(191, 219, 254, 0.85);
        }
        .report-surface-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .report-surface-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
            }
        }
        .report-kicker {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            background: rgba(59, 130, 246, 0.12);
            border: 1px solid rgba(59, 130, 246, 0.22);
            font-size: 0.72rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: #1d4ed8;
        }
        .report-section-title {
            font-size: 1.35rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: #0f1c2f;
            margin-top: 0.75rem;
        }
        .report-section-desc {
            margin-top: 0.45rem;
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(15, 28, 47, 0.65);
            max-width: 560px;
        }
        .report-pill-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.55rem 1.2rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            background: #fff;
            color: #1e3a8a;
            border-color: rgba(148, 163, 184, 0.35);
        }
        .report-pill-btn:hover {
            border-color: rgba(59, 130, 246, 0.45);
            box-shadow: 0 12px 30px -18px rgba(59, 130, 246, 0.55);
        }
        .report-pill-btn--primary {
            background: linear-gradient(120deg, #2563eb, #3b82f6);
            color: #ffffff;
            border-color: transparent;
        }
        .report-pill-btn--primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px -24px rgba(37, 99, 235, 0.6);
        }
        .report-pill-btn--danger {
            color: #be123c;
            border-color: rgba(244, 63, 94, 0.25);
            background: rgba(254, 226, 226, 0.65);
        }
        .report-pill-btn--danger:hover {
            border-color: rgba(244, 63, 94, 0.45);
            box-shadow: 0 18px 40px -26px rgba(244, 63, 94, 0.55);
        }
        .report-info-grid {
            display: grid;
            gap: 1.35rem;
        }
        @media (min-width: 768px) {
            .report-info-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        .metric-card {
            background: rgba(248, 250, 255, 0.95);
            border-radius: 22px;
            border: 1px solid rgba(199, 210, 254, 0.65);
            padding: 1.4rem 1.5rem;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.85);
        }
        .metric-card h3 {
            font-size: 0.75rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(15, 28, 47, 0.55);
        }
        .metric-card strong {
            display: block;
            margin-top: 0.65rem;
            font-size: 1.6rem;
            font-weight: 600;
            color: #0f1c2f;
        }
        .metric-card span {
            display: block;
            margin-top: 0.35rem;
            font-size: 0.85rem;
            color: rgba(15, 28, 47, 0.55);
        }
        .report-alert {
            background: rgba(254, 226, 226, 0.75);
            border: 1px solid rgba(248, 113, 113, 0.45);
            color: #991b1b;
            border-radius: 18px;
            padding: 0.9rem 1rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .report-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.92rem;
        }
        .report-table thead tr {
            background: rgba(226, 232, 240, 0.55);
        }
        .report-table th {
            padding: 0.9rem 1rem;
            font-weight: 600;
            color: rgba(15, 28, 47, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.7rem;
        }
        .report-table td {
            padding: 0.9rem 1rem;
            border-bottom: 1px solid rgba(203, 213, 225, 0.45);
        }
        .report-table tbody tr:hover {
            background: rgba(226, 232, 240, 0.35);
        }
        .line-chart-grid-line { stroke: rgba(191, 219, 254, 0.7); stroke-dasharray: 3 4; }
        .line-chart-axis-text { font-size: 11px; fill: rgba(15, 28, 47, 0.5); user-select: none; }
        .pie-segment { cursor: pointer; transition: transform 0.2s cubic-bezier(0.21, 1.02, 0.73, 1); transform-origin: center center; }
        .pie-segment:hover { transform: scale(1.04); }
        .chart-path { transition: d 0.3s ease-out; }
        details summary {
            cursor: pointer;
            border-radius: 18px;
            padding: 1rem 1.25rem;
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
            font-weight: 600;
        }
        details[open] > div {
            margin-top: 1.25rem;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 22px;
            border: 1px solid rgba(191, 219, 254, 0.7);
            padding: 1.5rem;
        }
    </style>
</head>
<body class="bg-neutral-100">
    <div id="root"></div>
    <div id="toast-container"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, Fragment } = React;

        const Y = 15; // Projection years
        const czk = new Intl.NumberFormat("cs-CZ", { style: "currency", currency: "CZK", maximumFractionDigits: 0 });
        const pct = new Intl.NumberFormat("cs-CZ", { style: "percent", minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        const parse = (v) => (typeof v === "string" ? Number(v.replace(/[^\d.,-]/g, "").replace(",", ".")) : Number(v)) || 0;
        const createFund = (name, r) => ({ id: crypto.randomUUID(), name, returnStr: String(r), amountStr: "0", amountStrY1: "0", failureYear: 0 });

        const formatRecoveryTime = (years) => {
            if (years === null) return "nedojde k zotavení";
            if (years < 0) return "ihned";
            if (years <= 0.08) return "< 1 měsíc";
            const y = Math.floor(years);
            const m = Math.round((years % 1) * 12);
            let result = [];
            if (y > 0) result.push(`${y} ${y === 1 ? "rok" : y < 5 ? "roky" : "let"}`);
            if (m > 0) result.push(`${m} ${m === 1 ? "měsíc" : m < 5 ? "měsíce" : "měsíců"}`);
            return result.length > 0 ? result.join(" a ") : "okamžitě";
        };
        
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000);
        };

        const MoneyInput = ({ value, onChange }) => {
            const [currentValue, setCurrentValue] = useState(value);
            const ref = useRef(null);

            useEffect(() => {
                if (document.activeElement !== ref.current) {
                    const numValue = parse(value);
                    setCurrentValue(numValue > 0 ? czk.format(numValue) : '');
                }
            }, [value]);
            
            const handleFocus = (e) => {
                const numericValue = parse(e.target.value);
                setCurrentValue(numericValue === 0 ? '' : numericValue);
            };

            const handleBlur = (e) => {
                const numericValue = parse(e.target.value);
                onChange(String(numericValue));
                setCurrentValue(numericValue > 0 ? czk.format(numericValue) : '');
            };

            const handleChange = (e) => {
                setCurrentValue(e.target.value);
            };

            return <input ref={ref} type="text" inputMode="numeric" className="w-full rounded-xl border border-slate-200 bg-white/90 px-3 py-2 text-right outline-none focus:border-sky-500 focus:ring-2 focus:ring-sky-100 tabular-nums transition shadow-inner" value={currentValue} onChange={handleChange} onFocus={handleFocus} onBlur={handleBlur} autoComplete="off" />;
        };

        const InfoCard = ({ title, value, subValue }) => (
            <div className="metric-card">
                <h3>{title}</h3>
                <strong className="tabular-nums">{value}</strong>
                {subValue && <span>{subValue}</span>}
            </div>
        );

        const ReportHero = ({ lastSaved }) => (
            <header className="report-hero">
                <div className="report-shell report-hero-grid">
                    <div>
                        <div className="report-hero-brand">FairLife</div>
                        <span className="report-hero-kicker">Report investičního portfolia</span>
                        <h1 className="report-hero-title">Přehled vašeho finančního světa</h1>
                        <p className="report-hero-text">
                            Sledujte výkonnost fondů, analyzujte cashflow a připravte pro klienty precizní výstupy v jednom elegantním prostředí.
                        </p>
                        {lastSaved && (
                            <p className="report-hero-text" style={{ fontSize: '0.78rem', letterSpacing: '0.18em', textTransform: 'uppercase', marginTop: '2rem' }}>
                                Synchronizováno v {lastSaved}
                            </p>
                        )}
                    </div>
                    <div className="report-hero-cards">
                        <div className="report-hero-card">
                            <small>Interaktivní řízení</small>
                            <h3>Import, export a přehled všech změn na jednom místě</h3>
                            <p>
                                Spravujte kompletní strukturu portfolia, sdílejte reporty s klienty a mějte jistotu v datech díky automatickému ukládání.
                            </p>
                        </div>
                        <div className="report-hero-card">
                            <small>Podrobné analýzy</small>
                            <h3>XRRI, projekce výnosů i vizualizace portfolia bez nutnosti dalších nástrojů</h3>
                            <p>
                                Interaktivní grafy, scénáře s další investicí i simulace krachu fondů pomohou lépe vysvětlit budoucí vývoj klientům.
                            </p>
                        </div>
                    </div>
                </div>
            </header>
        );

        function App() {
            const [lastSaved, setLastSaved] = useState(null);

            const [codya, setCodya] = useState([
                createFund("PFFL", 7.5), createFund("Fond reverzních hypoték", 6.65), createFund("Silverline R.E.", 10), createFund("Vigo Direct", 8),
                createFund("Adax", 12), createFund("Julius Meinl fond", 14.5), createFund("Penta R.E.", 14), createFund("Penta Equity", 14),
                createFund("Artefin - Henry IF", 8.5), createFund("FČKD", 7.5)
            ]);
            const [avant, setAvant] = useState([
                createFund("r2p invest", 8.5), createFund("Gartal", 7), createFund("Realia", 6), createFund("EBM", 8), createFund("Wero", 8),
                createFund("Vihorev", 8.5), createFund("Real Luxembourg", 8), createFund("Aguila", 7.5), createFund("Spilberk", 7), createFund("Semper", 11)
            ]);
            
            const getTimeString = () => new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });

            useEffect(() => { 
                try { 
                    const s = localStorage.getItem('investmentCalculatorState'); 
                    if (s) { 
                        const d = JSON.parse(s); 
                        if (d.codya) setCodya(d.codya); 
                        if (d.avant) setAvant(d.avant); 
                        showToast("Data byla úspěšně načtena."); 
                    } 
                    setLastSaved(getTimeString());
                } catch (e) { 
                    showToast("Nepodařilo se načíst uložená data.", 'error'); 
                } 
            }, []);
            
            useEffect(() => { 
                try { 
                    const stateToSave = { codya, avant };
                    localStorage.setItem('investmentCalculatorState', JSON.stringify(stateToSave));
                    setLastSaved(getTimeString());
                } catch (e) {
                    console.error("Failed to save state:", e);
                } 
            }, [codya, avant]);

            const exportState = () => {
                try {
                    const stateToSave = { codya, avant };
                    const blob = new Blob([JSON.stringify(stateToSave, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `portfolio-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("Portfolio bylo úspěšně exportováno.");
                } catch (e) {
                    showToast("Chyba při exportu portfolia.", "error");
                    console.error("Export failed:", e);
                }
            };
            
            const importState = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        if (importedState.codya && importedState.avant) {
                            setCodya(importedState.codya);
                            setAvant(importedState.avant);
                            showToast("Portfolio bylo úspěšně importováno.");
                        } else {
                            throw new Error("Invalid file structure");
                        }
                    } catch (err) {
                        showToast("Chyba při importu souboru.", "error");
                        console.error("Import failed:", err);
                    }
                };
                reader.readAsText(file);
                event.target.value = null;
            };
            
            const resetAll = () => {
                const resetAmounts = (funds) => funds.map(f => ({ ...f, amountStr: '0', amountStrY1: '0', failureYear: 0 }));
                setCodya(resetAmounts);
                setAvant(resetAmounts);
                showToast("Celé portfolio bylo vynulováno.");
            };
            
            const portfolioAnalysis = useMemo(() => {
                const allFunds = [...codya, ...avant].map(f => ({ 
                    ...f, 
                    amount: parse(f.amountStr), 
                    amountY1: parse(f.amountStrY1),
                    r: parse(f.returnStr) / 100,
                    failureYear: parseInt(f.failureYear, 10) || 0
                }));

                const initialFunds = allFunds.filter(f => f.amount > 0 || f.amountY1 > 0);
                if (initialFunds.length === 0) return { hasData: false };

                const totalInvestedInitial = allFunds.reduce((sum, f) => sum + f.amount, 0);
                const totalInvestedY1 = allFunds.reduce((sum, f) => sum + f.amountY1, 0);
                const totalInvestedWithFollowUp = totalInvestedInitial + totalInvestedY1;

                const initiallyInvestedFunds = allFunds.filter(f => f.amount > 0);
                const weightedSumInitial = initiallyInvestedFunds.reduce((sum, f) => sum + f.amount * f.r, 0);
                const weightedReturnInitial = totalInvestedInitial > 0 ? weightedSumInitial / totalInvestedInitial : 0;

                const hasFollowUpInvestment = totalInvestedY1 > 0;
                const hasFailure = allFunds.some(f => f.failureYear > 0);
                
                const projection = [];
                let totalLoss = 0;
                let failureEvents = [];
                let recoveryTime = null;

                let baselineValue = totalInvestedInitial;
                let followUp = { value: totalInvestedInitial, activeFunds: allFunds.filter(f=>f.amount > 0).map(f => ({...f, currentValue: f.amount})) };
                let failure = { value: totalInvestedInitial, activeFunds: allFunds.filter(f=>f.amount > 0).map(f => ({...f, currentValue: f.amount})) };

                for (let year = 1; year <= Y; year++) {
                    const yearData = { year };

                    const baselineStart = baselineValue;
                    const baselineInterest = baselineStart * weightedReturnInitial;
                    baselineValue += baselineInterest;
                    yearData.baseline = { start: baselineStart, interest: baselineInterest, end: baselineValue };

                    ['followUp', 'failure'].forEach(type => {
                        const scenario = type === 'followUp' ? followUp : failure;
                        const start = scenario.value;

                        const currentRate = start > 0 ? scenario.activeFunds.reduce((s,f) => s + (f.currentValue/start) * f.r, 0) : 0;
                        const interest = start * currentRate;
                        scenario.activeFunds.forEach(f => { f.currentValue *= (1 + f.r); });
                        
                        if (year === 1 && totalInvestedY1 > 0) {
                             allFunds.forEach(origF => {
                                if(origF.amountY1 > 0){
                                    const existing = scenario.activeFunds.find(af => af.id === origF.id);
                                    if(existing) {
                                        existing.currentValue += origF.amountY1;
                                    } else {
                                        scenario.activeFunds.push({...origF, currentValue: origF.amountY1});
                                    }
                                }
                           });
                        }
                        const valueAfterDeposit = scenario.activeFunds.reduce((s,f) => s+f.currentValue, 0);

                        let loss = 0;
                        let valueBeforeCrash = valueAfterDeposit;
                        if (type === 'failure' && hasFailure) {
                            const failingThisYear = scenario.activeFunds.filter(f => f.failureYear === year);
                            if (failingThisYear.length > 0) {
                                loss = failingThisYear.reduce((s,f) => s + f.currentValue, 0);
                                totalLoss += loss;
                                failureEvents.push({ year, loss });
                                scenario.activeFunds = scenario.activeFunds.filter(f => f.failureYear !== year);
                            }
                        }
                        
                        scenario.value = scenario.activeFunds.reduce((s,f) => s+f.currentValue, 0);
                        yearData[type] = { start, interest, end: scenario.value, loss, valueBeforeCrash };
                    });

                    projection.push(yearData);
                }

                if (hasFailure) {
                    let lastYearBelowInvestment = -1;
                    let lastCrashYearBeforeRecovery = -1;
                    projection.forEach(p => {
                        if (p.failure.end < totalInvestedWithFollowUp) {
                            lastYearBelowInvestment = p.year;
                            const relevantCrashes = failureEvents.filter(e => e.year <= p.year);
                            if(relevantCrashes.length > 0) {
                                lastCrashYearBeforeRecovery = Math.max(...relevantCrashes.map(e => e.year));
                            }
                        }
                    });
                    if (lastYearBelowInvestment !== -1 && lastCrashYearBeforeRecovery !== -1) {
                         for (let i = lastYearBelowInvestment - 1; i < projection.length; i++) {
                            const pCurrent = projection[i];
                            const pPrev = projection[i-1] || { failure: { end: totalInvestedInitial }};
                            if(pPrev.failure.end < totalInvestedWithFollowUp && pCurrent.failure.end >= totalInvestedWithFollowUp){
                                const needed = totalInvestedWithFollowUp - pPrev.failure.end;
                                const gain = pCurrent.failure.end - pPrev.failure.end;
                                const partial = gain > 0 ? needed / gain : 0;
                                recoveryTime = (pCurrent.year - lastCrashYearBeforeRecovery) + partial;
                                break;
                            }
                         }
                    } else if(totalInvestedInitial > 0 && projection[0] && projection[0].failure.end >= totalInvestedWithFollowUp){
                       recoveryTime = 0;
                    }
                }
                
                const investedFundsInitial = allFunds.filter(f => f.amount > 0).map(f => ({ name: f.name, amount: f.amount }));
                const fundsAfterY1 = allFunds.map(f => {
                    let amountAfterY1 = (f.amount * (1 + (projection[0]?.baseline.interest / projection[0]?.baseline.start || 0) )) + f.amountY1;
                    return { name: f.name, amount: amountAfterY1 };
                }).filter(f => f.amount > 0);

                const weightedReturnAfterY1 = projection[1] ? projection[1].followUp.interest / projection[1].followUp.start : weightedReturnInitial;

                return {
                    hasData: true, totalInvestedInitial, weightedReturnInitial,
                    hasFollowUpInvestment, totalInvestedWithFollowUp, weightedReturnAfterY1,
                    hasFailure, totalLoss, recoveryTime, failureEvents,
                    projection, 
                    investedFundsInitial, fundsAfterY1
                };
            }, [codya, avant]);
            
            return (
                <Fragment>
                    <ReportHero lastSaved={lastSaved} />
                    <main className="report-main">
                        <div className="report-shell report-stack">
                            <Summary analysis={portfolioAnalysis} />
                            <DataManagement
                                onExport={exportState}
                                onImport={importState}
                                onReset={resetAll}
                                lastSaved={lastSaved}
                            />
                            <Group title="AVANT" list={avant} setList={setAvant} portfolioTotal={portfolioAnalysis.totalInvestedInitial} />
                            <Group title="CODYA" list={codya} setList={setCodya} portfolioTotal={portfolioAnalysis.totalInvestedInitial} />
                            <LineChart analysis={portfolioAnalysis} />
                            <PieChart analysis={portfolioAnalysis} />
                            <ProjectionTable analysis={portfolioAnalysis} />
                            <AnnuityCalculator analysis={portfolioAnalysis} />
                            <section className="report-surface">
                                <details>
                                    <summary className="flex items-center justify-between text-base">
                                        <span>Vysvětlivky a použité metriky</span>
                                        <svg className="summary-arrow w-5 h-5 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clipRule="evenodd" /></svg>
                                    </summary>
                                    <div className="text-sm text-neutral-700 space-y-4">
                                        <h4 className="font-semibold text-neutral-800">Co je to vážené průměrné zhodnocení?</h4>
                                        <p>Jedná se o průměrné očekávané zhodnocení celého portfolia. Výpočet zohledňuje, jak velká část portfolia je v jednotlivých fondech. Fond, do kterého jste investovali více peněz, má na výsledný průměr větší vliv (váhu).</p>
                                    </div>
                                </details>
                            </section>
                        </div>
                    </main>
                    <footer className="report-shell pb-10 text-center text-xs text-slate-500">
                        © {new Date().getFullYear()} Ondřej Lacina · Nástroj slouží pouze pro ilustrativní účely.
                    </footer>
                </Fragment>
            );
        }

        const DataManagement = ({ onExport, onImport, onReset, lastSaved }) => {
            const fileInputRef = useRef(null);
            return (
                <section className="report-surface report-surface--soft">
                    <input type="file" ref={fileInputRef} onChange={onImport} accept=".json" style={{ display: 'none' }} />
                    <div className="report-surface-header">
                        <div>
                            <span className="report-kicker">Správa dat</span>
                            <h2 className="report-section-title">Synchronizujte portfolio během vteřiny</h2>
                            <p className="report-section-desc">
                                Importujte aktuální stav investic, sdílejte klientům exporty a udržujte historii bezpečně uloženou v prohlížeči.
                            </p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <button onClick={onExport} className="report-pill-btn report-pill-btn--primary">Exportovat do .json</button>
                            <button onClick={() => fileInputRef.current?.click()} className="report-pill-btn">Importovat z .json</button>
                            <button onClick={onReset} className="report-pill-btn report-pill-btn--danger">Vynulovat portfolio</button>
                        </div>
                    </div>
                    <div className="mt-6 grid gap-4 sm:grid-cols-2">
                        <div className="rounded-2xl border border-sky-100/80 bg-white/80 px-4 py-3 text-sm text-sky-800">
                            <strong className="block text-xs uppercase tracking-[0.2em] text-sky-500/80 mb-2">Tip pro prezentaci</strong>
                            Změny se ukládají automaticky. Export můžete klientovi poslat jako přílohu nebo uložit pro další schůzky.
                        </div>
                        <div className="rounded-2xl border border-slate-200/70 bg-white/70 px-4 py-3 text-sm text-slate-600 flex items-center justify-between">
                            <span>Poslední synchronizace</span>
                            <span className="font-semibold text-slate-900">{lastSaved || 'čeká na první záznam'}</span>
                        </div>
                    </div>
                </section>
            );
        };
        
        const SegmentSummary = ({ analysis, title }) => {
            if (!analysis || !analysis.hasData) return null;
            const { totalInvested, weightedReturn } = analysis;
            return (
                <div className="mt-8">
                    <h3 className="text-sm font-semibold text-slate-600 uppercase tracking-[0.18em] mb-3">Souhrn skupiny {title}</h3>
                    <div className="grid sm:grid-cols-2 gap-3">
                        <InfoCard title={`Investováno v ${title}`} value={czk.format(totalInvested)} />
                        <InfoCard title="Očekávaný roční výnos" value={pct.format(weightedReturn)} />
                    </div>
                </div>
            );
        };

        const Group = ({ title, list, setList, portfolioTotal }) => {
            const add = () => setList(p => [...p, createFund("Nový fond", 5)]);
            const remove = (id) => setList(p => p.filter(f => f.id !== id));
            const reset = () => setList(p => p.map(f => ({...f, amountStr: '0', amountStrY1: '0', failureYear: 0})));
            const patchFund = (id, patch) => setList(p => p.map(f => f.id === id ? { ...f, ...patch } : f));

            const handleDemo = () => {
                 let demoData;
                const codyaDemoFunds = ["PFFL", "Silverline R.E.", "Adax", "Penta R.E."];
                const avantDemoFunds = ["r2p invest", "Vihorev", "Real Luxembourg", "Semper"];
                if (title === 'CODYA') demoData = list.map(f => codyaDemoFunds.includes(f.name) ? { ...f, amountStr: '250000' } : { ...f, amountStr: '0' });
                else if (title === 'AVANT') demoData = list.map(f => avantDemoFunds.includes(f.name) ? { ...f, amountStr: '250000' } : { ...f, amountStr: '0' });
                if (demoData) setList(demoData);
            };
            
            const segmentAnalysis = useMemo(() => {
                const fundsInSegment = list.map(f => ({ ...f, amount: parse(f.amountStr), r: parse(f.returnStr) / 100 }));
                const investedFunds = fundsInSegment.filter(f => f.amount > 0);
                if (investedFunds.length === 0) return { hasData: false, totalInvested: 0, weightedReturn: 0 };
                const totalInvested = investedFunds.reduce((sum, f) => sum + f.amount, 0);
                const weightedSum = investedFunds.reduce((sum, f) => sum + f.amount * f.r, 0);
                const weightedReturn = totalInvested > 0 ? weightedSum / totalInvested : 0;
                return { hasData: true, totalInvested, weightedReturn };
            }, [list]);

            const groupTotal = segmentAnalysis.totalInvested;

            return (
                <section className="report-surface">
                    <div className="report-surface-header">
                        <div>
                            <span className="report-kicker">Vstupy</span>
                            <h2 className="report-section-title">Vstupy – {title}</h2>
                            <p className="report-section-desc">Spravujte transakce a sledujte výkonnost jednotlivých fondů partnerů.</p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <button onClick={handleDemo} className="report-pill-btn">Ukázka</button>
                            <button onClick={reset} className="report-pill-btn report-pill-btn--danger">Smazat vše</button>
                            <button onClick={add} className="report-pill-btn report-pill-btn--primary">Přidat řádek</button>
                        </div>
                    </div>
                    <div className="mt-6 overflow-x-auto">
                        <table className="report-table text-sm">
                            <thead>
                                <tr>
                                    <th className="min-w-[180px]">Fond</th>
                                    <th className="min-w-[140px]">Oček. zhodnocení</th>
                                    <th className="min-w-[160px] text-right">Počáteční vklad</th>
                                    <th className="min-w-[160px] text-right">Vklad po 1. roce</th>
                                    <th className="min-w-[150px]">Krach po roce</th>
                                    <th className="min-w-[140px] text-right">Podíl ve skupině</th>
                                    <th className="min-w-[140px] text-right">Podíl v portfoliu</th>
                                    <th className="w-12"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {list.map(f => {
                                    const amount = parse(f.amountStr);
                                    const segmentShare = groupTotal > 0 ? amount / groupTotal : 0;
                                    const portfolioShare = portfolioTotal > 0 ? amount / portfolioTotal : 0;
                                    return (
                                        <tr key={f.id}>
                                            <td>
                                                <input
                                                    className="w-full rounded-xl border border-slate-200 bg-white/90 px-3 py-2 outline-none focus:border-sky-500 focus:ring-2 focus:ring-sky-100"
                                                    defaultValue={f.name}
                                                    onBlur={e => patchFund(f.id, { name: e.target.value })}
                                                />
                                            </td>
                                            <td>
                                                <div className="relative">
                                                    <input
                                                        type="text"
                                                        inputMode="decimal"
                                                        className="w-full rounded-xl border border-slate-200 bg-white/90 px-3 py-2 pr-10 text-right outline-none focus:border-sky-500 focus:ring-2 focus:ring-sky-100"
                                                        defaultValue={f.returnStr}
                                                        onBlur={e => patchFund(f.id, { returnStr: e.target.value })}
                                                    />
                                                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">%</span>
                                                </div>
                                            </td>
                                            <td className="text-right"><MoneyInput value={f.amountStr} onChange={v => patchFund(f.id, { amountStr: v })} /></td>
                                            <td className="text-right"><MoneyInput value={f.amountStrY1} onChange={v => patchFund(f.id, { amountStrY1: v })} /></td>
                                            <td>
                                                <select
                                                    className="w-full rounded-xl border border-slate-200 bg-white/90 px-3 py-2 text-sm focus:border-red-500 focus:ring-2 focus:ring-rose-100"
                                                    value={f.failureYear}
                                                    onChange={e => patchFund(f.id, { failureYear: parseInt(e.target.value, 10) })}
                                                >
                                                    <option value="0">Nikdy</option>
                                                    {Array.from({ length: Y }, (_, i) => i + 1).map(year => (
                                                        <option key={year} value={year}>Po {year}. roce</option>
                                                    ))}
                                                </select>
                                            </td>
                                            <td className="text-right tabular-nums">{pct.format(segmentShare)}</td>
                                            <td className="text-right tabular-nums">{pct.format(portfolioShare)}</td>
                                            <td className="text-center">
                                                <button onClick={() => remove(f.id)} className="inline-flex items-center justify-center rounded-full p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    <SegmentSummary analysis={segmentAnalysis} title={title} />
                </section>
            );
        };

        const Summary = ({ analysis }) => {
            if (!analysis.hasData) {
                return (
                    <section className="report-surface report-surface--soft">
                        <span className="report-kicker">Souhrn portfolia</span>
                        <h2 className="report-section-title mt-3">Zadejte první investici</h2>
                        <p className="report-section-desc">Vyplňte alespoň jeden fond, aby se zobrazil souhrn včetně scénářů a projekcí.</p>
                    </section>
                );
            }

            const totalContributions = analysis.hasFollowUpInvestment ? analysis.totalInvestedWithFollowUp : analysis.totalInvestedInitial;
            const latestProjection = analysis.projection[analysis.projection.length - 1];
            const projectedValue = latestProjection ? latestProjection.baseline.end : totalContributions;
            const netGain = projectedValue - totalContributions;
            const totalReturnPct = totalContributions > 0 ? netGain / totalContributions : 0;
            const annualReturn = analysis.hasFollowUpInvestment ? analysis.weightedReturnAfterY1 : analysis.weightedReturnInitial;
            const breakEven = analysis.projection.find(p => p.baseline.end >= totalContributions);
            const horizonMonths = Math.max(1, Math.round((breakEven ? breakEven.year : Y) * 12));

            const metrics = [
                { title: 'Vaše celkové vklady', value: czk.format(totalContributions) },
                { title: 'Aktuální hodnota', value: czk.format(projectedValue) },
                { title: 'Čistý výnos', value: czk.format(netGain) },
                { title: 'Celkové zhodnocení', value: pct.format(totalReturnPct) },
                { title: 'Průměrný roční výnos', value: pct.format(annualReturn) },
                { title: 'Předpokládaná doba investice', value: `${horizonMonths} měs.` }
            ];

            const alertMessage = analysis.hasFailure
                ? 'Portfolio obsahuje simulaci krachu fondu. Sledujte níže dobu zotavení a kumulativní ztrátu.'
                : 'Souhrn vychází z aktuálně zadaných investic. Přidejte další vklady nebo aktualizujte výnosy pro přesnější projekce.';

            return (
                <section className="report-surface report-surface--soft">
                    <div className="report-surface-header">
                        <div>
                            <span className="report-kicker">Souhrn portfolia</span>
                            <h2 className="report-section-title">Souhrn Vašeho portfolia</h2>
                            <p className="report-section-desc">Klíčové ukazatele, které určují celkovou velikost portfolia a výkon Vašich investic.</p>
                        </div>
                        <div className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/70 border border-slate-200 text-xs font-semibold text-slate-600">
                            <span className="w-2 h-2 rounded-full bg-sky-500"></span>
                            Částky v CZK
                        </div>
                    </div>
                    <div className="report-alert mt-6">{alertMessage}</div>
                    <div className="report-info-grid mt-6">
                        {metrics.map(metric => (
                            <InfoCard key={metric.title} title={metric.title} value={metric.value} />
                        ))}
                    </div>
                    <div className="mt-8 grid md:grid-cols-2 gap-4">
                        <div className="rounded-2xl border border-slate-200/70 bg-white/85 p-5">
                            <h3 className="text-sm font-semibold text-slate-600 uppercase tracking-[0.18em]">Základní scénář</h3>
                            <div className="mt-4 grid gap-3">
                                <div className="flex items-center justify-between text-sm text-slate-600">
                                    <span>Počáteční investice</span>
                                    <span className="font-semibold text-slate-900 tabular-nums">{czk.format(analysis.totalInvestedInitial)}</span>
                                </div>
                                <div className="flex items-center justify-between text-sm text-slate-600">
                                    <span>Očekávaný roční výnos</span>
                                    <span className="font-semibold text-slate-900 tabular-nums">{pct.format(analysis.weightedReturnInitial)}</span>
                                </div>
                            </div>
                        </div>
                        {analysis.hasFollowUpInvestment && (
                            <div className="rounded-2xl border border-sky-200/70 bg-sky-50/60 p-5">
                                <h3 className="text-sm font-semibold text-slate-600 uppercase tracking-[0.18em]">Scénář s dalším vkladem</h3>
                                <div className="mt-4 grid gap-3">
                                    <div className="flex items-center justify-between text-sm text-slate-600">
                                        <span>Celkem investováno</span>
                                        <span className="font-semibold text-slate-900 tabular-nums">{czk.format(analysis.totalInvestedWithFollowUp)}</span>
                                    </div>
                                    <div className="flex items-center justify-between text-sm text-slate-600">
                                        <span>Očekávaný roční výnos</span>
                                        <span className="font-semibold text-slate-900 tabular-nums">{pct.format(analysis.weightedReturnAfterY1)}</span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    {analysis.hasFailure && (
                        <div className="mt-8 grid md:grid-cols-2 gap-4">
                            <InfoCard title="Celková kumulativní ztráta" value={`-${czk.format(analysis.totalLoss)}`} />
                            <InfoCard title="Doba zotavení na celkový vklad" value={formatRecoveryTime(analysis.recoveryTime)} subValue="od posledního relevantního krachu" />
                        </div>
                    )}
                </section>
            );
        };
        
        const useResizeObserver = (ref) => {
            const [dimensions, setDimensions] = useState({ width: 0, height: 0 });
            useEffect(() => {
                const observeTarget = ref.current;
                if (!observeTarget) return;
                const observer = new ResizeObserver(entries => { if (entries[0]) setDimensions(entries[0].contentRect); });
                observer.observe(observeTarget);
                return () => observer.unobserve(observeTarget);
            }, [ref]);
            return dimensions;
        };
        
        const useChartLogic = (analysis, width, height) => {
            return useMemo(() => {
                if (!analysis.hasData || width === 0) return { hasData: false };
                
                const { projection, totalInvestedInitial, totalInvestedWithFollowUp, hasFollowUpInvestment, hasFailure } = analysis;
                const margin = { top: 20, right: 20, bottom: 40, left: 70 };
                
                const allValues = projection.flatMap(p => [p.baseline.end, p.followUp.end, p.failure ? p.failure.end : 0]);

                const yMax = Math.max(...allValues, totalInvestedWithFollowUp) * 1.05;
                const xMax = Y;

                const xScale = (year) => margin.left + (year / xMax) * (width - margin.left - margin.right);
                const yScale = (value) => height - margin.bottom - (value / yMax) * (height - margin.top - margin.bottom);
                
                const scaledBaseline = [{x: xScale(0), y: yScale(totalInvestedInitial)}, ...projection.map(p => ({ x: xScale(p.year), y: yScale(p.baseline.end) }))];
                
                let scaledFollowUp = [];
                if (hasFollowUpInvestment) {
                    scaledFollowUp.push({x: xScale(0), y: yScale(totalInvestedInitial)});
                    scaledFollowUp.push({ x: xScale(1), y: yScale(projection[0].baseline.end) });
                    scaledFollowUp.push({ x: xScale(1), y: yScale(projection[0].followUp.end) });
                    projection.slice(1).forEach(p => {
                        scaledFollowUp.push({ x: xScale(p.year), y: yScale(p.followUp.end) });
                    });
                }

                let scaledFailure = [];
                if(hasFailure) {
                    scaledFailure.push({ x: xScale(0), y: yScale(totalInvestedInitial) });
                    projection.forEach(p => {
                        if (p.year === 1 && hasFollowUpInvestment) {
                            scaledFailure.push({ x: xScale(1), y: yScale(projection[0].baseline.end) });
                            scaledFailure.push({ x: xScale(1), y: yScale(p.failure.valueBeforeCrash) });
                        }
                        if (p.failure.loss > 0) {
                             scaledFailure.push({ x: xScale(p.year), y: yScale(p.failure.valueBeforeCrash) });
                             scaledFailure.push({ x: xScale(p.year), y: yScale(p.failure.end) });
                        } else {
                             const lastPoint = scaledFailure[scaledFailure.length-1];
                             if(!lastPoint || lastPoint.x !== xScale(p.year)){
                                scaledFailure.push({ x: xScale(p.year), y: yScale(p.failure.end) });
                             } else {
                                 lastPoint.y = yScale(p.failure.end);
                             }
                        }
                    });
                }

                const scaledDepositsPoints = [];
                scaledDepositsPoints.push({ x: xScale(0), y: yScale(totalInvestedInitial) });
                if (hasFollowUpInvestment) {
                    scaledDepositsPoints.push({ x: xScale(1), y: yScale(totalInvestedInitial) });
                    scaledDepositsPoints.push({ x: xScale(1), y: yScale(totalInvestedWithFollowUp) });
                    scaledDepositsPoints.push({ x: xScale(Y), y: yScale(totalInvestedWithFollowUp) });
                } else { scaledDepositsPoints.push({ x: xScale(Y), y: yScale(totalInvestedInitial) }); }

                const yAxisTicks = Array.from({ length: 6 }).map((_, i) => ({ value: (yMax / 5) * i, y: yScale((yMax / 5) * i) }));
                const xAxisTicks = Array.from({ length: Math.floor(Y / 5) + 1 }).map((_, i) => ({ year: i * 5, x: xScale(i * 5) }));

                return { hasData: true, margin, width, height, scaledBaseline, scaledFollowUp, yAxisTicks, xAxisTicks, yScale, xMax, scaledDepositsPoints, scaledFailure, analysis };
            }, [analysis, width, height]);
        };

        const createPath = (points) => {
             if (points.length < 2) return ""; return "M " + points.map(p => `${p.x},${p.y}`).join(" L ");
        };

        const LineChart = ({ analysis }) => {
            const containerRef = useRef(null);
            const svgRef = useRef(null); 
            const dimensions = useResizeObserver(containerRef);
            const [tooltip, setTooltip] = useState(null);
            const chartData = useChartLogic(analysis, dimensions.width, dimensions.height);
            const animationFrameId = useRef();

            const handleMouseMove = (e) => {
                if (!chartData.hasData || !svgRef.current) return;
                const clientX = e.clientX; const clientY = e.clientY;
                cancelAnimationFrame(animationFrameId.current);
                animationFrameId.current = requestAnimationFrame(() => {
                    if (!svgRef.current) return;
                    const { margin, width, yScale, xMax, analysis } = chartData;
                    const svg = svgRef.current;
                    const rect = svg.getBoundingClientRect();
                    const mouseX = Math.max(margin.left, Math.min(clientX - rect.left, width - margin.right));
                    const yearFractional = (mouseX - margin.left) / (width - margin.left - margin.right) * xMax;
                    
                    const interpolate = (projection, key = 'end') => {
                         if(!projection || projection.length === 0) return 0;
                         const yearFloor = Math.floor(yearFractional);
                         const yearCeil = Math.ceil(yearFractional);
                         if (yearFloor < 1) {
                            const startValue = analysis.totalInvestedInitial;
                            const firstYear = projection[0];
                            if (!firstYear) return startValue;
                             // Interpolate between start and end of year 1, considering deposits/crashes
                             if(key === 'end'){ // Normal interpolation
                                return startValue + (firstYear[key] - startValue) * yearFractional;
                             }
                         }
                         const p1 = projection[yearFloor - 1];
                         const p2 = projection[yearCeil - 1] || projection[projection.length - 1];
                         if(!p1 || !p2) return 0;
                         const t = yearFractional - yearFloor;
                         return p1[key] + (p2[key] - p1[key]) * t;
                    };

                    const valBaseline = interpolate(analysis.projection.map(p => p.baseline));
                    const valFollowUp = analysis.hasFollowUpInvestment ? interpolate(analysis.projection.map(p => p.followUp)) : null;
                    const valFailure = analysis.hasFailure ? interpolate(analysis.projection.map(p => p.failure)) : null;

                    const date = new Date();
                    date.setDate(date.getDate() + yearFractional * 365.25);
                    setTooltip({ x: mouseX, yBaseline: yScale(valBaseline), yFollowUp: valFollowUp ? yScale(valFollowUp) : null, yFailure: valFailure ? yScale(valFailure) : null, mouseX: clientX - rect.left, mouseY: clientY - rect.top, date: date.toLocaleDateString('cs-CZ'), valBaseline, valFollowUp, valFailure });
                });
            };

            const handleMouseLeave = () => { cancelAnimationFrame(animationFrameId.current); setTooltip(null); };
            
            return (
                <section className="report-surface">
                    <div className="report-surface-header mb-4">
                        <div>
                            <span className="report-kicker">Vývoj portfolia</span>
                            <h2 className="report-section-title">Vývoj hodnoty portfolia s predikcí do roku {new Date().getFullYear() + Y}</h2>
                            <p className="report-section-desc">Simulace porovnává základní scénář, dodatečný vklad a stres test s krachy fondů. Sledujte, jak se portfolio vyvíjí v čase.</p>
                        </div>
                    </div>
                    <div className="relative h-96" ref={containerRef}>
                        {!chartData.hasData ? (
                            <div className="h-full flex items-center justify-center text-neutral-500">Zadejte investici pro zobrazení grafu.</div>
                        ) : (
                            <svg ref={svgRef} width="100%" height="100%" onMouseMove={handleMouseMove} onMouseLeave={handleMouseLeave}>
                                <g>
                                    {chartData.yAxisTicks.map(({ value, y }) => (
                                        <g key={y}>
                                            <line className="line-chart-grid-line" x1={chartData.margin.left} y1={y} x2={chartData.width - chartData.margin.right} y2={y}></line>
                                            <text className="line-chart-axis-text" x={chartData.margin.left - 8} y={y + 4} textAnchor="end">{(value/1000000).toFixed(1)} M</text>
                                        </g>
                                    ))}
                                    {chartData.xAxisTicks.map(({ year, x }) => <text key={year} className="line-chart-axis-text" x={x} y={chartData.height - chartData.margin.bottom + 16} textAnchor="middle">{year === 0 ? "Dnes" : new Date().getFullYear() + year}</text>)}
                                </g>
                                <path d={createPath(chartData.scaledDepositsPoints)} fill="none" stroke="#c7d2fe" strokeWidth="2" strokeDasharray="6 6"/>
                                <path d={createPath(chartData.scaledBaseline)} fill="none" stroke="#2563eb" strokeWidth="2.8" className="chart-path"/>
                                {analysis.hasFollowUpInvestment && <path d={createPath(chartData.scaledFollowUp)} fill="none" stroke="#0ea5e9" strokeWidth="2.6" className="chart-path"/>}
                                {analysis.hasFailure && <path d={createPath(chartData.scaledFailure)} fill="none" stroke="#f97316" strokeWidth="2.6" className="chart-path"/>}
                                <circle cx={chartData.scaledBaseline[0]?.x} cy={chartData.scaledBaseline[0]?.y} r="5" fill="#2563eb" stroke="white" strokeWidth="2" />
                                
                                <g transform={`translate(${chartData.margin.left}, ${chartData.height - 10})`} className="flex items-center gap-x-4">
                                    <g><circle cx="0" cy="-4" r="4" fill="#2563eb"></circle><text className="line-chart-axis-text" x="8" y="0">Základní</text></g>
                                    {analysis.hasFollowUpInvestment && <g transform="translate(90, 0)"><circle cx="0" cy="-4" r="4" fill="#0ea5e9"></circle><text className="line-chart-axis-text" x="8" y="0">S vkladem</text></g>}
                                    {analysis.hasFailure && <g transform={`translate(${analysis.hasFollowUpInvestment ? 180 : 90}, 0)`}><circle cx="0" cy="-4" r="4" fill="#f97316"></circle><text className="line-chart-axis-text" x="8" y="0">Stres test</text></g>}
                                    <g transform={`translate(${analysis.hasFailure ? (analysis.hasFollowUpInvestment ? 270: 180) : (analysis.hasFollowUpInvestment ? 180 : 90)}, 0)`}><line x1="0" y1="-4" x2="15" y2="-4" stroke="#c7d2fe" strokeDasharray="4 4" strokeWidth="2"></line><text className="line-chart-axis-text" x="20" y="0">Vklady</text></g>
                                </g>

                                {tooltip && (
                                    <g className="pointer-events-none">
                                        <line stroke="#4b5563" strokeWidth="1" y1={chartData.margin.top} y2={chartData.height - chartData.margin.bottom} x1={tooltip.x} x2={tooltip.x}></line>
                                        <circle r="5" fill="#2563eb" stroke="white" strokeWidth="2" cx={tooltip.x} cy={tooltip.yBaseline}></circle>
                                        {tooltip.yFollowUp && <circle r="5" fill="#0ea5e9" stroke="white" strokeWidth="2" cx={tooltip.x} cy={tooltip.yFollowUp}></circle>}
                                        {tooltip.yFailure && <circle r="5" fill="#f97316" stroke="white" strokeWidth="2" cx={tooltip.x} cy={tooltip.yFailure}></circle>}
                                    </g>
                                )}
                            </svg>
                        )}
                        {tooltip && (
                             <div className="absolute z-20 p-3 text-sm bg-white/95 rounded-2xl shadow-2xl border border-slate-200 pointer-events-none" style={{ left: tooltip.mouseX + 15, top: tooltip.mouseY + 15 }}>
                                <div className="font-semibold text-slate-800 mb-1">{tooltip.date}</div>
                                <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-600"></div><span className="text-slate-600">{czk.format(tooltip.valBaseline)}</span></div>
                                {tooltip.valFollowUp && <div className="flex items-center gap-2 mt-1"><div className="w-2 h-2 rounded-full bg-sky-500"></div><span className="text-slate-600">{czk.format(tooltip.valFollowUp)}</span></div>}
                                {tooltip.valFailure && <div className="flex items-center gap-2 mt-1"><div className="w-2 h-2 rounded-full bg-orange-500"></div><span className="text-slate-600">{czk.format(tooltip.valFailure)}</span></div>}
                            </div>
                        )}
                    </div>
                </section>
            );
        };
        
        const PieChart = ({ analysis }) => {
            const [view, setView] = useState('initial');
            const tooltipRef = useRef(null);
            if (!analysis.hasData) return null;
            const { investedFundsInitial, fundsAfterY1, hasFollowUpInvestment } = analysis;
            const dataToShow = view === 'initial' || !hasFollowUpInvestment ? investedFundsInitial : fundsAfterY1;
            const title = view === 'initial' || !hasFollowUpInvestment ? 'Počáteční alokace portfolia' : 'Alokace po 1. roce';
            const pieTotal = dataToShow.reduce((sum, d) => sum + d.amount, 0);
            const CHART_COLORS = [ '#38bdf8', '#4ade80', '#fbbf24', '#f87171', '#a78bfa', '#2dd4bf', '#f472b6', '#a3e635', '#fde047', '#ef4444', '#c084fc', '#67e8f9', '#fda4af', '#d9f99d', '#f59e0b', '#7dd3fc', '#6ee7b7', '#fca5a5', '#d8b4fe', '#99f6e4' ];
            let angle = -90;
            const segments = dataToShow.map((d, i) => {
                const percent = pieTotal > 0 ? d.amount / pieTotal : 0;
                const pathData = `M ${50 + 48*Math.cos(angle*Math.PI/180)},${50 + 48*Math.sin(angle*Math.PI/180)} A 48,48 0 ${percent > 0.5 ? 1:0},1 ${50 + 48*Math.cos((angle+percent*360)*Math.PI/180)},${50 + 48*Math.sin((angle+percent*360)*Math.PI/180)} L ${50 + 30*Math.cos((angle+percent*360)*Math.PI/180)},${50 + 30*Math.sin((angle+percent*360)*Math.PI/180)} A 30,30 0 ${percent > 0.5 ? 1:0},0 ${50 + 30*Math.cos(angle*Math.PI/180)},${50 + 30*Math.sin(angle*Math.PI/180)} Z`;
                angle += percent * 360;
                return { ...d, path: pathData, color: CHART_COLORS[i % CHART_COLORS.length] };
            });
            const handleSegmentMouseMove = (e, segment) => {
                const tooltip = tooltipRef.current; if (!tooltip) return;
                tooltip.innerHTML = `<div class="font-bold text-neutral-800">${segment.name}</div><div class="text-neutral-600">${czk.format(segment.amount)} (${pct.format(pieTotal > 0 ? segment.amount / pieTotal : 0)})</div>`;
                tooltip.style.display = 'block'; tooltip.style.left = `${e.pageX + 15}px`; tooltip.style.top = `${e.pageY + 15}px`;
            };
            const handleSegmentMouseOut = () => { const tooltip = tooltipRef.current; if (tooltip) tooltip.style.display = 'none'; };
            return (
                 <section className="report-surface">
                    <div ref={tooltipRef} className="absolute z-30 p-3 text-sm bg-white/95 rounded-2xl shadow-2xl border border-slate-200 pointer-events-none" style={{ display: 'none' }}></div>
                    <div className="report-surface-header mb-6">
                        <div>
                            <span className="report-kicker">Alokace portfolia</span>
                            <h2 className="report-section-title">{title}</h2>
                            <p className="report-section-desc">Prozkoumejte rozložení kapitálu mezi jednotlivé fondy a sledujte, které pozice mají největší vliv na celkový výkon.</p>
                        </div>
                        {hasFollowUpInvestment && (
                            <div className="inline-flex items-center gap-1.5 bg-slate-100 p-1.5 rounded-full">
                                <button onClick={() => setView('initial')} className={`px-3 py-1 text-xs font-semibold rounded-full transition ${view === 'initial' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:bg-white/60'}`}>Start</button>
                                <button onClick={() => setView('afterY1')} className={`px-3 py-1 text-xs font-semibold rounded-full transition ${view === 'afterY1' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:bg-white/60'}`}>Po 1. roce</button>
                            </div>
                        )}
                    </div>
                    <div className="grid sm:grid-cols-2 gap-8 items-center">
                        <div className="w-full max-w-xs mx-auto">
                            <svg viewBox="0 0 100 100">{segments.map((seg, i) => (<path key={i} d={seg.path} fill={seg.color} stroke="#fff" strokeWidth="1" className="pie-segment" onMouseMove={(e) => handleSegmentMouseMove(e, seg)} onMouseOut={handleSegmentMouseOut} />))}</svg>
                        </div>
                        <div className="space-y-2 text-sm max-h-80 overflow-y-auto pr-1">
                            {segments.map((seg, i) => (
                                <div key={i} className="flex items-center gap-3 rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2">
                                    <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: seg.color }}></div>
                                    <div className="flex-1 truncate" title={seg.name}>{seg.name}</div>
                                    <div className="font-semibold tabular-nums text-slate-700">{pct.format(pieTotal > 0 ? seg.amount / pieTotal : 0)}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                 </section>
            );
        };
        
        const ProjectionTable = ({ analysis }) => {
            if (!analysis.hasData) return null;

            const { projection, totalInvestedInitial, totalInvestedY1, hasFollowUpInvestment, hasFailure, failureEvents } = analysis;
            const today = new Date();
            const formatDate = (date) => date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric', year: 'numeric' });

            return (
                <section className="report-surface">
                    <div className="report-surface-header mb-4">
                        <div>
                            <span className="report-kicker">Časová osa</span>
                            <h2 className="report-section-title">Detailní srovnání projekcí</h2>
                            <p className="report-section-desc">Každoroční vývoj portfolia v jednotlivých scénářích včetně dalších vkladů a případných krachů fondů.</p>
                        </div>
                        <span className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/70 border border-slate-200 text-xs font-semibold text-slate-600">Výchozí datum: {today.toLocaleDateString('cs-CZ')}</span>
                    </div>
                    <div className="overflow-x-auto max-h-[450px] rounded-3xl border border-slate-200/70">
                        <table className="report-table w-full text-sm text-left">
                            <thead className="sticky top-0">
                                <tr>
                                    <th className="py-3 px-3">Datum</th>
                                    <th className="py-3 px-3">Událost</th>
                                    <th className="py-3 px-3 text-right">Hodnota (bez další inv.)</th>
                                    {hasFollowUpInvestment && <th className="py-3 px-3 text-right">Hodnota (s další inv.)</th>}
                                    {hasFailure && <th className="py-3 px-3 text-right">Hodnota (při krachu)</th>}
                                </tr>
                            </thead>
                            <tbody className="bg-white">
                                <tr className="border-b border-slate-100 bg-neutral-50 font-semibold">
                                    <td className="py-2 px-3 tabular-nums">{formatDate(today)}</td>
                                    <td className="py-2 px-3">Počáteční vklad</td>
                                    <td className="py-2 px-3 tabular-nums text-right">{czk.format(totalInvestedInitial)}</td>
                                    {hasFollowUpInvestment && <td className="py-2 px-3 tabular-nums text-right">{czk.format(totalInvestedInitial)}</td>}
                                    {hasFailure && <td className="py-2 px-3 tabular-nums text-right">{czk.format(totalInvestedInitial)}</td>}
                                </tr>
                                {projection.map((p, index) => {
                                    const futureDate = new Date(); futureDate.setFullYear(futureDate.getFullYear() + p.year);
                                    const isY1 = p.year === 1;
                                    const failureThisYear = hasFailure ? failureEvents.find(e => e.year === p.year) : null;
                                    return (
                                        <Fragment key={p.year}>
                                            <tr className="border-b border-slate-100 last:border-0 hover:bg-neutral-50">
                                                <td className="py-2 px-3 tabular-nums align-top">{formatDate(futureDate)}</td>
                                                <td className="py-2 px-3 align-top">Po {p.year}. roce</td>
                                                <td className="py-2 px-3 tabular-nums text-right"><div className="font-semibold">{czk.format(p.baseline.end)}</div><div className="text-xs text-green-600">+{czk.format(p.baseline.interest)}</div></td>
                                                {hasFollowUpInvestment && <td className="py-2 px-3 tabular-nums text-right"><div className="font-semibold">{czk.format(p.followUp.end)}</div><div className="text-xs text-green-600">+{czk.format(p.followUp.interest)}</div></td>}
                                                {hasFailure && <td className="py-2 px-3 tabular-nums text-right"><div className="font-semibold">{czk.format(p.failure.end)}</div><div className="text-xs text-green-600">+{czk.format(p.failure.interest)}</div></td>}
                                            </tr>
                                            {isY1 && hasFollowUpInvestment && (<tr className="border-b border-slate-100 bg-sky-50 font-medium"><td className="py-2 px-3 tabular-nums">{formatDate(futureDate)}</td><td className="py-2 px-3">Dodatečná investice</td><td className="py-2 px-3 text-center">-</td><td className="py-2 px-3 tabular-nums text-right text-sky-700">+{czk.format(totalInvestedY1)}</td>{hasFailure && <td className="py-2 px-3 text-center">-</td>}</tr>)}
                                            {failureThisYear && (<tr className="border-b border-slate-100 bg-red-50 font-medium"><td className="py-2 px-3 tabular-nums">{formatDate(futureDate)}</td><td className="py-2 px-3">Krach fondu / Ztráta</td><td className="py-2 px-3 text-center">-</td>{hasFollowUpInvestment && <td className="py-2 px-3 text-center">-</td>}<td className="py-2 px-3 tabular-nums text-right text-red-700">-{czk.format(failureThisYear.loss)}</td></tr>)}
                                        </Fragment>
                                    )
                                })}
                            </tbody>
                        </table>
                    </div>
                </section>
            );
        };

        const AnnuityCalculator = ({ analysis }) => {
            const [monthlyAnnuityStr, setMonthlyAnnuityStr] = useState('');
            const monthlyAnnuity = useMemo(() => parse(monthlyAnnuityStr), [monthlyAnnuityStr]);
            const annualAnnuity = useMemo(() => monthlyAnnuity * 12, [monthlyAnnuity]);
            const annuityResult = useMemo(() => {
                if (!analysis.hasData || analysis.projection.length === 0) return null;
                const hasFollowUp = analysis.hasFollowUpInvestment;
                
                const relevantProjection = hasFollowUp ? analysis.projection.map(p => p.followUp) : analysis.projection.map(p => p.baseline);
                const lastYear = relevantProjection[relevantProjection.length-1];
                const relevantReturn = lastYear.interest / lastYear.start;

                if (relevantReturn <= 0 || monthlyAnnuity <= 0) return null;
                
                const targetCapital = annualAnnuity / relevantReturn;
                const startingCapital = hasFollowUp ? (analysis.projection[0].baseline.end + analysis.totalInvestedY1) : analysis.totalInvestedInitial;
                
                if (startingCapital >= targetCapital) return { type: 'sufficient', totalInvested: analysis.totalInvestedInitial };
                
                const yearsNeeded = Math.log(targetCapital / startingCapital) / Math.log(1 + relevantReturn);
                const targetDate = new Date();
                const startYearOffset = hasFollowUp ? 1 : 0;
                targetDate.setFullYear(targetDate.getFullYear() + Math.floor(yearsNeeded + startYearOffset), targetDate.getMonth() + ((yearsNeeded+startYearOffset) % 1) * 12);
                return { type: 'future', monthlyAnnuity, targetCapital, targetDate: targetDate.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' }) };
            }, [monthlyAnnuity, annualAnnuity, analysis]);
            if (!analysis.hasData) return null;
            return (
                 <section className="report-surface">
                    <div className="report-surface-header mb-4">
                        <div>
                            <span className="report-kicker">Dlouhodobá renta</span>
                            <h2 className="report-section-title">Kalkulačka nekonečné renty</h2>
                            <p className="report-section-desc">Zjistěte, jak velký kapitál potřebujete pro trvalou měsíční rentu nebo zda Vaše současné portfolio již cíl splňuje.</p>
                        </div>
                        <span className="text-xs text-slate-500">Pracuje s očekávaným zhodnocením portfolia</span>
                    </div>
                    <div className="flex items-center gap-4 flex-wrap">
                        <label className="flex-shrink-0 text-sm font-semibold text-slate-600 uppercase tracking-[0.16em]">Požadovaná měsíční renta</label>
                        <div className="flex-grow max-w-xs"><MoneyInput value={monthlyAnnuityStr} onChange={setMonthlyAnnuityStr} /></div>
                        {annualAnnuity > 0 && <span className="text-neutral-500 text-sm">(což odpovídá {czk.format(annualAnnuity)} ročně)</span>}
                    </div>
                    {annuityResult && (
                        <div className="mt-5 text-sm text-slate-800 bg-sky-50 border border-sky-200 rounded-2xl p-4">
                            {annuityResult.type === 'sufficient' && (
                                <span><strong>Gratulujeme!</strong> Vaše portfolio s aktuální hodnotou <strong>{czk.format(annuityResult.totalInvested)}</strong> je již nyní dostatečně velké, aby generovalo požadovanou roční rentu.</span>
                            )}
                            {annuityResult.type === 'future' && (
                                <span>Pro měsíční rentu <strong>{czk.format(annuityResult.monthlyAnnuity)}</strong> potřebujete kapitál o velikosti přibližně <strong>{czk.format(annuityResult.targetCapital)}</strong>. Při současném tempu růstu byste této částky mohli dosáhnout okolo <strong>{annuityResult.targetDate}</strong>.</span>
                            )}
                        </div>
                    )}
                    <p className="text-xs text-neutral-500 pt-3">*Tento výpočet předpokládá, že si z portfolia každý rok vyberete pouze vygenerovaný výnos (zhodnocení) a jistina zůstane nedotčena, aby mohla generovat další výnos v následujícím roce.</p>
                </section>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
